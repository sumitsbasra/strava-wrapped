<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strava Wrapped 2025</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=Instrument+Serif:ital@0;1&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --orange-hot: #FF4D00;
      --coral: #FF7F6B;
      --peach: #FFB199;
      --cream: #FFF8F0;
      --night: #0A0A0A;
      --gold: #FFD700;
      --electric-blue: #00D4FF;
      --mint: #00FFB2;
      --violet: #8B5CF6;
      --rose: #FF3366;
      --strava-orange: #FC4C02;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--night);
      color: var(--cream);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      -webkit-font-smoothing: antialiased;
    }

    /* Login Screen */
    .login-screen {
      position: fixed;
      inset: 0;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .login-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .login-logo {
      font-family: 'Teko', sans-serif;
      font-size: clamp(3rem, 12vw, 6rem);
      font-weight: 700;
      transform: skewX(-6deg);
      background: linear-gradient(180deg, var(--cream) 20%, var(--peach) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      font-style: italic;
      opacity: 0.7;
      margin-bottom: 48px;
    }

    .login-description {
      max-width: 400px;
      text-align: center;
      font-size: 1rem;
      opacity: 0.6;
      line-height: 1.6;
      margin-bottom: 40px;
    }

    .strava-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 16px 32px;
      background: var(--strava-orange);
      color: white;
      border: none;
      border-radius: 100px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .strava-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 40px rgba(252, 76, 2, 0.4);
    }

    .strava-btn svg {
      width: 24px;
      height: 24px;
    }

    .demo-link {
      margin-top: 24px;
      font-size: 0.85rem;
      opacity: 0.5;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .demo-link:hover {
      opacity: 0.8;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      z-index: 2001;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .emoji-cycler {
      font-size: 4rem;
      margin-bottom: 24px;
      animation: bounce 1s infinite alternate;
    }

    @keyframes bounce {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-10px);
      }
    }

    .loading-progress-container {
      width: 200px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 16px;
    }

    .loading-progress-bar {
      height: 100%;
      width: 0%;
      background: var(--strava-orange);
      border-radius: 3px;
      transition: width 0.3s ease;
      animation: progressIndeterminate 2s infinite linear;
    }

    @keyframes progressIndeterminate {
      0% {
        width: 0%;
        transform: translateX(-100%);
      }

      50% {
        width: 50%;
      }

      100% {
        width: 100%;
        transform: translateX(100%);
      }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 24px;
      letter-spacing: 0.05em;
    }

    .loading-subtext {
      font-size: 0.9rem;
      opacity: 0.5;
      margin-top: 8px;
    }

    /* Wrapped content wrapper */
    .wrapped-content {
      transition: opacity 0.5s ease;
    }

    .wrapped-content.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .gradient-spotlight {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: var(--base-color, #0a0a0a);
      overflow: hidden;
      transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gradient-spotlight::before,
    .gradient-spotlight::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gradient-spotlight::before {
      width: 140vmax;
      height: 140vmax;
      background: radial-gradient(circle, var(--spot-color-1, var(--orange-hot)) 0%, transparent 60%);
      top: var(--spot-y-1, 20%);
      left: var(--spot-x-1, 60%);
      transform: translate(-50%, -50%);
      opacity: 0.8;
    }

    .gradient-spotlight::after {
      width: 120vmax;
      height: 120vmax;
      background: radial-gradient(circle, var(--spot-color-2, var(--violet)) 0%, transparent 55%);
      top: var(--spot-y-2, 60%);
      left: var(--spot-x-2, 10%);
      transform: translate(-50%, -50%);
      opacity: 0.7;
    }

    .progress-container {
      position: fixed;
      top: 16px;
      left: 16px;
      right: 16px;
      display: flex;
      gap: 4px;
      z-index: 1000;
    }

    .progress-bar {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }

    .progress-bar.completed .progress-fill {
      width: 100%;
    }

    .progress-bar.active .progress-fill {
      animation: progress 15s linear forwards;
    }

    .progress-fill {
      height: 100%;
      background: var(--cream);
      width: 0;
      border-radius: 3px;
    }

    @keyframes progress {
      to {
        width: 100%;
      }
    }

    .nav-area {
      position: fixed;
      top: 50px;
      bottom: 0;
      width: 25%;
      z-index: 100;
      cursor: pointer;
    }

    .nav-area.left {
      left: 0;
    }

    .nav-area.right {
      right: 0;
    }

    .story-card {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      overflow: hidden;
      transform: scale(0.96);
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        visibility 0.6s;
    }

    .story-card.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .story-card.exiting {
      opacity: 0;
      transform: scale(1.04);
    }

    .hero-section {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px 24px;
      position: relative;
    }

    .mini-cards-row {
      display: flex;
      gap: 10px;
      margin-top: 28px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 400px;
    }

    .mini-card {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 16px;
      text-align: center;
      min-width: 85px;
      flex: 1;
      max-width: 120px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(16px) scale(0.95);
    }

    .mini-card.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .mini-card:nth-child(1) {
      transition: opacity 0.4s ease 1.0s, transform 0.4s ease 1.0s;
    }

    .mini-card:nth-child(2) {
      transition: opacity 0.4s ease 1.1s, transform 0.4s ease 1.1s;
    }

    .mini-card:nth-child(3) {
      transition: opacity 0.4s ease 1.2s, transform 0.4s ease 1.2s;
    }

    .mini-card:nth-child(4) {
      transition: opacity 0.4s ease 1.3s, transform 0.4s ease 1.3s;
    }

    .mini-card:nth-child(5) {
      transition: opacity 0.4s ease 1.4s, transform 0.4s ease 1.4s;
    }

    .mini-card:nth-child(6) {
      transition: opacity 0.4s ease 1.5s, transform 0.4s ease 1.5s;
    }

    .mini-card-icon {
      font-size: 1.4rem;
      line-height: 1;
      margin-bottom: 4px;
    }

    .mini-card-value {
      font-family: 'Teko', sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      line-height: 1;
      transform: skewX(-6deg);
      display: inline-block;
    }

    .mini-card-label {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.5;
      margin-top: 4px;
      white-space: nowrap;
    }

    .pr-cards-row {
      max-width: 500px;
    }

    .pr-cards-row .mini-card {
      min-width: 70px;
      max-width: 95px;
      padding: 10px 12px;
    }

    .pr-cards-row .mini-card-value {
      font-size: 1.2rem;
    }

    .stat-content,
    .intro-content,
    .summary-wrap {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.5s ease 0.2s, transform 0.5s ease 0.2s;
    }

    .story-card.active .stat-content,
    .story-card.active .intro-content,
    .story-card.active .summary-wrap {
      opacity: 1;
      transform: translateY(0);
    }

    .story-card.active .mini-card {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .noise {
      position: absolute;
      inset: 0;
      opacity: 0.035;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }

    .grid-overlay {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
      background-size: 80px 80px;
      pointer-events: none;
    }

    .glow {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      pointer-events: none;
      opacity: 0.5;
    }

    .card-intro,
    .card-distance,
    .card-time,
    .card-elevation,
    .card-heartrate,
    .card-calories,
    .card-activities,
    .card-streak,
    .card-pace,
    .card-kudos,
    .card-routes,
    .card-morning,
    .card-records,
    .card-month {
      background: transparent;
    }

    .card-summary {
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .glow {
      display: none;
    }

    .label {
      font-size: clamp(0.65rem, 1.2vw, 0.8rem);
      text-transform: uppercase;
      letter-spacing: 0.25em;
      opacity: 0.5;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .stat-huge {
      font-family: 'Teko', sans-serif;
      font-size: clamp(5rem, 24vw, 18rem);
      font-weight: 700;
      line-height: 0.85;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
    }

    .stat-unit {
      font-family: 'Teko', sans-serif;
      font-size: clamp(1.5rem, 5vw, 3.5rem);
      font-weight: 500;
      opacity: 0.7;
      margin-left: 8px;
      transform: skewX(-6deg);
      display: inline-block;
    }

    .context {
      font-size: clamp(0.95rem, 2.2vw, 1.25rem);
      font-weight: 400;
      line-height: 1.7;
      max-width: 480px;
      text-align: center;
      margin-top: 28px;
      opacity: 0.8;
    }

    .context em {
      font-family: 'Instrument Serif', serif;
      font-style: italic;
      color: var(--peach);
    }

    .highlight {
      color: var(--gold);
      font-weight: 600;
    }

    .intro-bg {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 50%, rgba(255, 77, 0, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 60% 80% at 30% 70%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse 70% 60% at 70% 30%, rgba(255, 51, 102, 0.1) 0%, transparent 50%);
      animation: introBreath 8s ease-in-out infinite;
    }

    @keyframes introBreath {

      0%,
      100% {
        opacity: 0.8;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    .intro-content {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .intro-label {
      font-size: clamp(0.7rem, 1.5vw, 0.85rem);
      letter-spacing: 0.35em;
      text-transform: uppercase;
      opacity: 0.5;
      margin-bottom: 24px;
    }

    .intro-year {
      font-family: 'Teko', sans-serif;
      font-size: clamp(6rem, 28vw, 18rem);
      font-weight: 700;
      line-height: 0.85;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
      background: linear-gradient(180deg, var(--cream) 20%, var(--peach) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .intro-wrapped {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(2rem, 9vw, 6rem);
      font-style: italic;
      margin-top: -5px;
      opacity: 0.85;
    }

    .intro-name {
      font-size: clamp(0.85rem, 2vw, 1.1rem);
      margin-top: 48px;
      opacity: 0.4;
      letter-spacing: 0.1em;
    }

    .tap-hint {
      position: absolute;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      opacity: 0.35;
      text-transform: uppercase;
    }

    .tap-hint::after {
      content: ' ‚Üí';
      animation: nudge 1.5s ease-in-out infinite;
      display: inline-block;
    }

    .stat-content {
      text-align: center;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .distance-visual {
      position: absolute;
      bottom: 12%;
      left: 0;
      right: 0;
      height: 3px;
      overflow: hidden;
    }

    .distance-line {
      height: 100%;
      background: linear-gradient(90deg, transparent 0%, var(--electric-blue) 20%, var(--mint) 50%, var(--gold) 80%, transparent 100%);
      animation: distanceMove 3s linear infinite;
    }

    @keyframes distanceMove {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .mountain-silhouette {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 35%;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 178, 0.08) 100%);
      clip-path: polygon(0% 100%, 5% 85%, 12% 90%, 20% 65%, 28% 80%, 38% 45%, 45% 60%, 55% 25%, 65% 50%, 72% 35%, 80% 55%, 88% 40%, 95% 70%, 100% 55%, 100% 100%);
    }

    .heartbeat-container {
      position: absolute;
      bottom: 18%;
      left: 0;
      right: 0;
      height: 60px;
      overflow: hidden;
      opacity: 0.5;
    }

    .heartbeat-svg {
      width: 200%;
      height: 100%;
      animation: heartScroll 3s linear infinite;
    }

    @keyframes heartScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-50%);
      }
    }

    .flame-glow {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 200px;
      background: radial-gradient(ellipse at center bottom, var(--orange-hot) 0%, transparent 70%);
      filter: blur(40px);
      opacity: 0.4;
      animation: flameFlicker 2s ease-in-out infinite;
    }

    @keyframes flameFlicker {

      0%,
      100% {
        opacity: 0.4;
        transform: translateX(-50%) scaleY(1);
      }

      50% {
        opacity: 0.6;
        transform: translateX(-50%) scaleY(1.1);
      }
    }

    .activity-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-top: 32px;
      width: 100%;
      max-width: 500px;
    }

    .activity-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px 12px;
      text-align: center;
    }

    .activity-emoji {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .activity-count {
      font-family: 'Teko', sans-serif;
      font-size: 1.6rem;
      font-weight: 600;
      transform: skewX(-6deg);
    }

    .activity-name {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
      margin-top: 4px;
    }

    .heatmap-container {
      margin-top: 36px;
      width: 100%;
      max-width: 90vw;
    }

    .heatmap {
      display: grid;
      grid-template-columns: repeat(52, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 2px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 2px;
      background: rgba(255, 255, 255, 0.08);
      transition: transform 0.1s;
    }

    .heatmap-cell:hover {
      transform: scale(1.5);
      z-index: 10;
    }

    .heatmap-cell.l1 {
      background: rgba(255, 77, 0, 0.25);
    }

    .heatmap-cell.l2 {
      background: rgba(255, 77, 0, 0.45);
    }

    .heatmap-cell.l3 {
      background: rgba(255, 77, 0, 0.7);
    }

    .heatmap-cell.l4 {
      background: var(--orange-hot);
      box-shadow: 0 0 6px rgba(255, 77, 0, 0.5);
    }

    .comparison {
      margin-top: 36px;
      width: 100%;
      max-width: 380px;
    }

    .comparison-row {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }

    .comparison-label {
      width: 70px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    .comparison-track {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 3px;
      overflow: hidden;
    }

    .comparison-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .comparison-fill.you {
      background: linear-gradient(90deg, var(--orange-hot), var(--gold));
    }

    .comparison-fill.avg {
      background: rgba(255, 255, 255, 0.25);
    }

    .comparison-value {
      width: 65px;
      text-align: right;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .kudos-field {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .kudos-heart {
      position: absolute;
      font-size: 1.5rem;
      animation: kudosFloat 7s ease-out infinite;
      opacity: 0;
    }

    @keyframes kudosFloat {
      0% {
        transform: translateY(100vh) scale(0.5) rotate(-10deg);
        opacity: 0;
      }

      10% {
        opacity: 0.7;
      }

      90% {
        opacity: 0.7;
      }

      100% {
        transform: translateY(-10vh) scale(1) rotate(10deg);
        opacity: 0;
      }
    }

    .time-distribution {
      margin-top: 32px;
      width: 100%;
      max-width: 450px;
    }

    .time-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      height: 100px;
      gap: 3px;
    }

    .time-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--gold) 0%, var(--orange-hot) 100%);
      border-radius: 2px 2px 0 0;
      opacity: 0.2;
    }

    .time-bar.peak {
      opacity: 1;
      box-shadow: 0 0 16px rgba(255, 215, 0, 0.4);
    }

    .time-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .time-label {
      font-size: 0.6rem;
      opacity: 0.35;
      text-transform: uppercase;
    }

    .records-stack {
      margin-top: 32px;
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .record-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px;
    }

    .record-icon {
      font-size: 1.6rem;
    }

    .record-info {
      flex: 1;
    }

    .record-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    .record-value {
      font-family: 'Teko', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 2px;
      transform: skewX(-6deg);
    }

    .record-date {
      font-size: 0.7rem;
      opacity: 0.4;
    }

    .month-chart-container {
      margin-top: 32px;
      width: 100%;
      max-width: 480px;
    }

    .month-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      height: 130px;
      gap: 6px;
    }

    .month-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .month-bar {
      width: 28px;
      background: linear-gradient(180deg, var(--electric-blue) 0%, var(--mint) 100%);
      border-radius: 4px 4px 0 0;
      opacity: 0.6;
    }

    .month-bar.best {
      background: linear-gradient(180deg, var(--gold) 0%, var(--orange-hot) 100%);
      opacity: 1;
      box-shadow: 0 0 20px rgba(255, 77, 0, 0.4);
    }

    .month-name {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.4;
    }

    .detail-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px 24px;
      text-align: center;
      width: 100%;
      max-width: 320px;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .detail-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    .detail-value {
      font-family: 'Teko', sans-serif;
      font-size: 2.2rem;
      font-weight: 600;
      transform: skewX(-6deg);
      line-height: 1;
    }

    .detail-desc {
      font-size: 0.8rem;
      opacity: 0.6;
      margin-top: 8px;
    }

    .segments-container {
      display: flex;
      gap: 24px;
      margin-top: 28px;
      width: 100%;
      max-width: 600px;
    }

    .segments-section {
      flex: 1;
    }

    .segments-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.6;
      margin-bottom: 12px;
    }

    .segment-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }

    .segment-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .segment-item.crown {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .segment-rank {
      font-family: 'Teko', sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      opacity: 0.4;
      width: 24px;
      text-align: center;
      transform: skewX(-6deg);
    }

    .segment-badge {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .segment-info {
      flex: 1;
      min-width: 0;
    }

    .segment-name {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .segment-meta {
      font-size: 0.65rem;
      opacity: 0.5;
      margin-top: 2px;
    }

    .pr-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 28px;
      width: 100%;
      max-width: 500px;
      justify-content: center;
    }

    .pr-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px;
      padding: 14px 18px;
      text-align: center;
      min-width: 90px;
      flex: 1;
      transition: transform 0.2s, background 0.2s;
    }

    .pr-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .pr-item.featured {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      flex-basis: 100%;
    }

    .pr-distance {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.5;
      margin-bottom: 6px;
    }

    .pr-time {
      font-family: 'Teko', sans-serif;
      font-size: 1.8rem;
      font-weight: 600;
      transform: skewX(-6deg);
      line-height: 1;
    }

    .pr-item.featured .pr-time {
      font-size: 2.2rem;
    }

    .pr-improvement {
      font-size: 0.7rem;
      color: var(--mint);
      margin-top: 6px;
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .segments-container {
        flex-direction: column;
        gap: 20px;
      }
    }

    .summary-wrap {
      width: 100%;
      max-width: 440px;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .summary-year {
      font-family: 'Teko', sans-serif;
      font-size: clamp(4rem, 16vw, 10rem);
      font-weight: 700;
      line-height: 0.9;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
    }

    .summary-tagline {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(1.1rem, 3.5vw, 1.8rem);
      font-style: italic;
      opacity: 0.85;
      margin-top: 4px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 100%;
    }

    .summary-stat {
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 18px 14px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-stat.wide {
      grid-column: span 3;
      padding: 28px;
    }

    .summary-num {
      font-family: 'Teko', sans-serif;
      font-size: clamp(1.8rem, 6vw, 2.8rem);
      font-weight: 600;
      line-height: 1;
      transform: skewX(-6deg);
    }

    .summary-lbl {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.6;
      margin-top: 6px;
    }

    @media (max-width: 600px) {
      .story-card {
        padding: 50px 20px;
      }

      .activity-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .summary-stat.wide {
        grid-column: span 2;
      }

      .month-bar {
        width: 18px;
      }
    }
  </style>
</head>

<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-logo">2025</div>
    <div class="login-subtitle">Wrapped</div>
    <p class="login-description">
      Connect your Strava account to see your personalized year in review with all your stats, PRs, and achievements.
    </p>
    <button class="strava-btn" onclick="connectStrava()">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169" />
      </svg>
      Connect with Strava
    </button>
    <div class="demo-link" onclick="loadDemoData()">or view with demo data</div>
  </div>

  <!-- Loading Screen -->
  <div class="loading-screen hidden" id="loadingScreen">
    <div class="emoji-cycler" id="emojiCycler">üèÉ</div>
    <div class="loading-text">Warming up...</div>
    <div class="loading-progress-container">
      <div class="loading-progress-bar"></div>
    </div>
    <div class="loading-subtext" id="loadingSubtext">Connecting to Strava</div>
  </div>

  <!-- Debug Log -->
  <div id="debugLog"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 200px; background: rgba(0,0,0,0.8); color: lime; font-family: monospace; font-size: 12px; overflow-y: auto; z-index: 9999; pointer-events: none; padding: 10px;">
  </div>

  <div class="gradient-spotlight" id="gradientSpotlight"></div>
  <div class="wrapped-content hidden" id="wrappedContent">
    <div class="progress-container" id="progressContainer"></div>
    <div class="nav-area left" onclick="prevCard()"></div>
    <div class="nav-area right" onclick="nextCard()"></div>

    <!-- 0: Intro -->
    <div class="story-card card-intro active" data-index="0">
      <div class="noise"></div>
      <div class="intro-bg"></div>
      <div class="hero-section">
        <div class="intro-content">
          <div class="intro-label">Your Year in Motion</div>
          <div class="intro-year">2025</div>
          <div class="intro-wrapped">Wrapped</div>
          <div class="intro-name">Sumit's Athletic Journey</div>
        </div>
        <div class="tap-hint">Tap to begin</div>
      </div>

    </div>

    <!-- 1: Distance -->
    <div class="story-card card-distance" data-index="1">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Total Distance</div>
          <div class="stat-huge"><span class="counter" data-target="2847">0</span><span class="stat-unit">km</span>
          </div>
          <div class="context">That's <em>San Francisco to New York</em> and halfway back.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">54.7</div>
              <div class="mini-card-label">km/week</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">87.3</div>
              <div class="mini-card-label">best week</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">42.2</div>
              <div class="mini-card-label">longest</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 2: Time -->
    <div class="story-card card-time" data-index="2">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Time Moving</div>
          <div class="stat-huge"><span class="counter" data-target="312">0</span><span class="stat-unit">hrs</span>
          </div>
          <div class="context">That's <em>13 full days</em> of pure motion.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">1:02</div>
              <div class="mini-card-label">avg/activity</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">4:12</div>
              <div class="mini-card-label">longest</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 3: Elevation -->
    <div class="story-card card-elevation" data-index="3">
      <div class="noise"></div>
      <div class="mountain-silhouette"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Elevation Gained</div>
          <div class="stat-huge"><span class="counter" data-target="38">0</span><span class="stat-unit">km</span></div>
          <div class="context">You climbed <em>4.3√ó the height of Everest</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">892m</div>
              <div class="mini-card-label">biggest climb</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">1,247m</div>
              <div class="mini-card-label">hilliest run</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 4: Heart Rate -->
    <div class="story-card card-heartrate" data-index="4">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Heartbeats During Workouts</div>
          <div class="stat-huge"><span class="counter" data-target="2.4">0</span><span class="stat-unit">million</span>
          </div>
          <div class="context">Your heart worked hard for every mile.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">187</div>
              <div class="mini-card-label">max</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">156</div>
              <div class="mini-card-label">avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">-4</div>
              <div class="mini-card-label">resting</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 5: Calories -->
    <div class="story-card card-calories" data-index="5">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Calories Burned</div>
          <div class="stat-huge"><span class="counter" data-target="186">0</span><span class="stat-unit">k</span></div>
          <div class="context">That's <em>743 Big Macs</em> worth of energy.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">510</div>
              <div class="mini-card-label">daily avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">3,847</div>
              <div class="mini-card-label">max</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 6: Activities -->
    <div class="story-card card-activities" data-index="6">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Total Activities</div>
          <div class="stat-huge"><span class="counter" data-target="312">0</span></div>
          <div class="context">That's <em>6 activities per week</em>. Only 53 rest days.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-icon">üèÉ</div>
              <div class="mini-card-value">198</div>
              <div class="mini-card-label">runs</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üö¥</div>
              <div class="mini-card-value">67</div>
              <div class="mini-card-label">rides</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üèä</div>
              <div class="mini-card-value">31</div>
              <div class="mini-card-label">swims</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üí™</div>
              <div class="mini-card-value">16</div>
              <div class="mini-card-label">other</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 7: Streak -->
    <div class="story-card card-streak" data-index="7">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Longest Streak</div>
          <div class="stat-huge"><span class="counter" data-target="47">0</span><span class="stat-unit">days</span>
          </div>
          <div class="context"><span class="highlight">April 3 ‚Üí May 19</span>. <em>Relentless.</em></div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">12</div>
              <div class="mini-card-label">current</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">85%</div>
              <div class="mini-card-label">active</div>
            </div>
          </div>
          <div class="heatmap-container" style="margin-top: 24px; max-width: 100%;">
            <div class="heatmap" id="heatmap"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- 8: Pace & PRs -->
    <div class="story-card card-pace" data-index="8">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Fastest Kilometer</div>
          <div class="stat-huge">3:42</div>
          <div class="context">October 12 tempo run. <em>18s faster than last year</em>.</div>
          <div class="mini-cards-row" style="max-width: 500px;">
            <div class="mini-card">
              <div class="mini-card-value">5:58</div>
              <div class="mini-card-label">1 mile</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">19:47</div>
              <div class="mini-card-label">5K</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">41:23</div>
              <div class="mini-card-label">10K</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">1:38</div>
              <div class="mini-card-label">half</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">3:28</div>
              <div class="mini-card-label">marathon üéâ</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 9: Kudos -->
    <div class="story-card card-kudos" data-index="9">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="kudos-field" id="kudosField"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Kudos Received</div>
          <div class="stat-huge"><span class="counter" data-target="4287">0</span></div>
          <div class="context">Your community showed up for you.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">13.7</div>
              <div class="mini-card-label">avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">89</div>
              <div class="mini-card-label">best</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">1,247</div>
              <div class="mini-card-label">given</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 10: Routes & Segments -->
    <div class="story-card card-routes" data-index="10">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Segments Conquered</div>
          <div class="stat-huge"><span class="counter" data-target="73">0</span></div>
          <div class="context">Your favorite stomping grounds.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-icon">üèÜ</div>
              <div class="mini-card-value">1</div>
              <div class="mini-card-label">legend</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üîÅ</div>
              <div class="mini-card-value">47</div>
              <div class="mini-card-label">efforts</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">3</div>
              <div class="mini-card-label">podiums</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 11: Morning -->
    <div class="story-card card-morning" data-index="11">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Favorite Start Time</div>
          <div class="stat-huge">6:34<span class="stat-unit">AM</span></div>
          <div class="context">You're an <em>early bird</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">67%</div>
              <div class="mini-card-label">before 8am</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">4:47</div>
              <div class="mini-card-label">earliest</div>
            </div>
          </div>
          <div class="time-distribution" style="margin-top: 24px;">
            <div class="time-bars" id="timeBars"></div>
            <div class="time-labels"><span class="time-label">5am</span><span class="time-label">9am</span><span
                class="time-label">1pm</span><span class="time-label">5pm</span><span class="time-label">9pm</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 12: Records -->
    <div class="story-card card-records" data-index="12">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Personal Records</div>
          <div class="stat-huge"><span class="counter" data-target="23">0</span></div>
          <div class="context">A year of breakthroughs.</div>
          <div class="mini-cards-row pr-cards-row" id="prCardsRow">
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">1mi</div>
              <div class="mini-card-label">5:58</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">5K</div>
              <div class="mini-card-label">19:47</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">10K</div>
              <div class="mini-card-label">41:23</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">Half</div>
              <div class="mini-card-label">1:38:12</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">Full</div>
              <div class="mini-card-label">3:28:44</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 13: Best Month -->
    <div class="story-card card-month" data-index="13">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Best Month</div>
          <div class="stat-huge"
            style="font-family: 'Instrument Serif', serif; font-style: italic; transform: none; line-height: 1.3; padding: 0.2em 0; overflow: visible;">
            October</div>
          <div class="context">You were <em>on fire</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">387</div>
              <div class="mini-card-label">km</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">34</div>
              <div class="mini-card-label">activities</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">3</div>
              <div class="mini-card-label">PRs</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 14: Summary -->
  <div class="story-card card-summary" data-index="14">
    <div class="noise"></div>
    <div class="summary-wrap">
      <div class="summary-header">
        <div class="summary-year">2025</div>
        <div class="summary-tagline">A Year of Relentless Progress</div>
      </div>
      <div class="summary-grid">
        <div class="summary-stat wide">
          <div class="summary-num">2,847 km</div>
          <div class="summary-lbl">Total Distance</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">312</div>
          <div class="summary-lbl">Activities</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">312 hrs</div>
          <div class="summary-lbl">Time</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">38 km</div>
          <div class="summary-lbl">Elevation</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">186k</div>
          <div class="summary-lbl">Calories</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">23</div>
          <div class="summary-lbl">PRs</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">47</div>
          <div class="summary-lbl">Day Streak</div>
        </div>
      </div>
    </div>

  </div>
  </div> <!-- end wrapped-content -->

  <script>
    const TOTAL_CARDS = 15;
    const AUTO_ADVANCE_TIME = 15000;
    let currentIndex = 0;
    let autoAdvanceTimer = null;

    // Gradient spotlight config for each card: [color1, x1, y1, color2, x2, y2, baseColor]
    const gradientConfigs = [
      ['#FF4D00', '50%', '30%', '#8B5CF6', '20%', '80%', '#1a0a10'],      // 0: intro
      ['#00D4FF', '70%', '20%', '#00FFB2', '20%', '75%', '#051518'],      // 1: distance
      ['#FF3366', '30%', '75%', '#FF4D00', '75%', '25%', '#180a10'],      // 2: time
      ['#00FFB2', '25%', '25%', '#00D4FF', '75%', '80%', '#051510'],      // 3: elevation
      ['#FF3366', '65%', '35%', '#8B5CF6', '25%', '70%', '#150810'],      // 4: heartrate
      ['#FF4D00', '50%', '75%', '#FFD700', '50%', '20%', '#181005'],      // 5: calories
      ['#00D4FF', '20%', '25%', '#8B5CF6', '80%', '75%', '#080a15'],      // 6: activities
      ['#FF4D00', '75%', '30%', '#FF3366', '25%', '75%', '#180805'],      // 7: streak
      ['#8B5CF6', '30%', '65%', '#00D4FF', '70%', '30%', '#0a0815'],      // 8: pace
      ['#00FFB2', '65%', '35%', '#FFD700', '30%', '70%', '#081510'],      // 9: kudos
      ['#FFD700', '35%', '70%', '#FF4D00', '70%', '25%', '#151005'],      // 10: routes
      ['#FFD700', '55%', '25%', '#FF4D00', '40%', '80%', '#151008'],      // 11: morning
      ['#FFD700', '70%', '30%', '#FF4D00', '25%', '70%', '#151008'],      // 12: records
      ['#00D4FF', '35%', '70%', '#00FFB2', '65%', '25%', '#051515'],      // 13: month
      ['#FF4D00', '45%', '35%', '#8B5CF6', '70%', '75%', '#150810'],      // 14: summary
    ];

    function updateGradient(index) {
      const config = gradientConfigs[index];
      const spotlight = document.getElementById('gradientSpotlight');
      spotlight.style.setProperty('--spot-color-1', config[0]);
      spotlight.style.setProperty('--spot-x-1', config[1]);
      spotlight.style.setProperty('--spot-y-1', config[2]);
      spotlight.style.setProperty('--spot-color-2', config[3]);
      spotlight.style.setProperty('--spot-x-2', config[4]);
      spotlight.style.setProperty('--spot-y-2', config[5]);
      spotlight.style.setProperty('--base-color', config[6]);
    }

    function init() {
      // Show wrapped content
      document.getElementById('wrappedContent').classList.remove('hidden');

      createProgressBars();
      createKudosHearts();
      updateProgressBars();
      updateGradient(0);
      startAutoAdvance();
    }

    function createProgressBars() {
      const container = document.getElementById('progressContainer');
      for (let i = 0; i < TOTAL_CARDS; i++) {
        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.innerHTML = '<div class="progress-fill"></div>';
        bar.onclick = (e) => { e.stopPropagation(); goToCard(i); };
        container.appendChild(bar);
      }
    }



    function createKudosHearts() {
      const container = document.getElementById('kudosField');
      for (let i = 0; i < 15; i++) {
        const heart = document.createElement('div');
        heart.className = 'kudos-heart';
        heart.textContent = 'üß°';
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDelay = Math.random() * 6 + 's';
        container.appendChild(heart);
      }
    }

    function updateProgressBars() {
      document.querySelectorAll('.progress-bar').forEach((bar, i) => {
        bar.classList.remove('active', 'completed');
        if (i < currentIndex) bar.classList.add('completed');
        else if (i === currentIndex) bar.classList.add('active');
      });
    }

    function animateCounters() {
      const card = document.querySelector('.story-card[data-index="' + currentIndex + '"]');
      if (!card) return;
      card.querySelectorAll('.counter').forEach(counter => {
        const target = parseFloat(counter.dataset.target);
        const start = performance.now();
        const duration = 1500;
        function update(now) {
          const progress = Math.min((now - start) / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          let val = target * eased;
          if (target >= 1000) counter.textContent = Math.floor(val).toLocaleString();
          else if (target < 10) counter.textContent = val.toFixed(1);
          else counter.textContent = Math.floor(val);
          if (progress < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
      });
    }

    function showCard(index) {
      const cards = document.querySelectorAll('.story-card');
      const currentCard = document.querySelector('.story-card.active');
      const nextCard = cards[index];

      // Animate gradient spotlight
      updateGradient(index);

      if (currentCard && currentCard !== nextCard) {
        currentCard.classList.add('exiting');
        currentCard.classList.remove('active');
        setTimeout(() => {
          currentCard.classList.remove('exiting');
        }, 600);
      }

      nextCard.classList.add('active');
      currentIndex = index;
      updateProgressBars();
      setTimeout(animateCounters, 300);
    }

    function goToCard(index) { showCard(index); resetAutoAdvance(); }
    function nextCard() { if (currentIndex < TOTAL_CARDS - 1) { showCard(currentIndex + 1); resetAutoAdvance(); } }
    function prevCard() { if (currentIndex > 0) { showCard(currentIndex - 1); resetAutoAdvance(); } }
    function startAutoAdvance() { if (currentIndex < TOTAL_CARDS - 1) autoAdvanceTimer = setTimeout(nextCard, AUTO_ADVANCE_TIME); }
    function resetAutoAdvance() { clearTimeout(autoAdvanceTimer); startAutoAdvance(); }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextCard(); }
      else if (e.key === 'ArrowLeft') { e.preventDefault(); prevCard(); }
    });

    let touchStartX = 0;
    document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
    document.addEventListener('touchend', (e) => {
      const diff = touchStartX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) diff > 0 ? nextCard() : prevCard();
    }, { passive: true });

    // ============================================
    // STRAVA OAUTH & DATA INTEGRATION
    // ============================================

    // Client ID is safe to expose (needed for OAuth redirect)
    // Client Secret is stored securely in Cloudflare environment variables
    const STRAVA_CLIENT_ID = '189090';
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Store for athlete data
    let athleteData = null;
    let activitiesData = [];

    function connectStrava() {
      const scope = 'read,activity:read_all,profile:read_all';
      const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${scope}`;
      window.location.href = authUrl;
    }

    async function exchangeToken(code) {
      showLoading('Authenticating...');

      try {
        // Use our secure serverless function to exchange the code
        // This keeps the client_secret safe on the server
        const response = await fetch('/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: code,
            redirect_uri: REDIRECT_URI,
            client_id: STRAVA_CLIENT_ID
          })
        });

        const data = await response.json();

        if (data.access_token) {
          localStorage.setItem('strava_access_token', data.access_token);
          localStorage.setItem('strava_refresh_token', data.refresh_token);
          localStorage.setItem('strava_athlete', JSON.stringify(data.athlete));
          athleteData = data.athlete;
          await fetchAllActivities(data.access_token);
        } else {
          throw new Error(data.error || 'Failed to get access token');
        }
      } catch (error) {
        console.error('Auth error:', error);
        alert(`Failed to connect to Strava: ${error.name} - ${error.message} at ${error.stack}`);
        hideLoading();
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    }

    async function fetchAllActivities(accessToken) {
      showLoading('Fetching your activities...');
      debugLog('fetchAllActivities started');

      const year = 2025;
      const startOfYear = new Date(year, 0, 1).getTime() / 1000;
      const endOfYear = new Date(year, 11, 31, 23, 59, 59).getTime() / 1000;

      let allActivities = [];
      let page = 1;
      const perPage = 200;

      try {
        while (true) {
          updateLoadingText(`Fetching activities (page ${page})...`);
          debugLog(`Fetching page ${page}...`);

          const response = await fetch(
            `https://www.strava.com/api/v3/athlete/activities?after=${startOfYear}&before=${endOfYear}&page=${page}&per_page=${perPage}`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
          );

          if (!response.ok) {
            const errorText = await response.text();
            debugLog(`Fetch failed: ${response.status} ${errorText}`);
            alert(`Debug: Fetch failed. Status: ${response.status}, Body: ${errorText}`);
            throw new Error('Failed to fetch activities');
          }

          const activities = await response.json();
          debugLog(`Page ${page} received: ${activities.length} activities`);

          if (activities.length === 0) break;

          allActivities = allActivities.concat(activities);
          page++;

          // Safety limit
          if (page > 20) break;
        }

        activitiesData = allActivities;
        debugLog(`Total activities fetched: ${activitiesData.length}`);
        updateLoadingText('Processing your year...');

        setTimeout(() => {
          processAndDisplayData();
        }, 500);

      } catch (error) {
        console.error('Fetch error:', error);
        debugLog(`Fetch error: ${error.message}`);
        alert('Failed to fetch activities. Please try again.');
        hideLoading();
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    }

    function processAndDisplayData() {
      debugLog('processAndDisplayData started');
      try {
        debugLog('Calculating stats...');
        const stats = calculateStats(activitiesData);
        debugLog('Stats calculated. Updating UI...');
        updateUIWithStats(stats);

        // Re-render charts with real data
        debugLog('Rendering charts...');
        createHeatmap(stats.heatmapData);
        createTimeBars(stats.timeDistribution);
        createMonthBars(stats.monthlyDistance);

        hideLoading();
        hideLogin();

        // Initialize other UI elements
        debugLog('Initializing UI components...');
        document.getElementById('wrappedContent').classList.remove('hidden'); // Reveal the UI!
        createProgressBars();
        createKudosHearts();
        updateProgressBars();
        updateGradient(0);
        startAutoAdvance();
        debugLog('UI Initialization complete');
      } catch (error) {
        console.error('Processing error:', error);
        debugLog(`Processing error: ${error.message}\n${error.stack}`);
        alert(`Error processing data: ${error.name} - ${error.message}\n${error.stack}`);
      }
    }

    function calculateStats(activities) {
      const stats = {
        totalDistance: 0,
        totalTime: 0,
        totalElevation: 0,
        totalCalories: 0,
        totalActivities: activities.length,
        activityTypes: {},
        kudos: 0,
        maxKudos: 0,
        totalComments: 0,
        maxHeartRate: 0,
        avgHeartRate: 0,
        heartRateCount: 0,
        prs: 0,
        fastestKm: Infinity,
        monthlyDistance: new Array(12).fill(0),
        monthlyActivities: new Array(12).fill(0),
        weeklyDistance: new Array(53).fill(0),
        startTimes: new Array(24).fill(0),
        longestStreak: 0,
        uniqueRoutes: new Set(),
        bestMonth: { index: 0, distance: 0 },

        // New stats
        longestActivityDist: 0,
        longestActivityTime: 0,
        maxElevationGain: 0,
        hilliestRun: 0,
        maxCalories: 0,
        activeDays: new Set(),
        heatmapData: Array(53).fill().map(() => Array(7).fill(0)),
        timeDistribution: new Array(16).fill(0), // 5am to 8pm

        fastestPaces: {
          '1mi': { time: Infinity, date: null },
          '5k': { time: Infinity, date: null },
          '10k': { time: Infinity, date: null },
          'half': { time: Infinity, date: null },
          'marathon': { time: Infinity, date: null }
        }
      };

      activities.forEach((activity, index) => {
        // Basic stats
        const dist = activity.distance || 0;
        const time = activity.moving_time || 0;
        const elev = activity.total_elevation_gain || 0;
        // Strava summary activities might not have calories, but rides have kilojoules
        let cals = activity.calories || 0;
        if (!cals && activity.kilojoules) {
          cals = activity.kilojoules; // Rough approximation for cycling
        }

        const date = new Date(activity.start_date);

        if (index < 5) {
          debugLog(`Activity ${activity.id} (${activity.type}): dist=${dist}, cals=${cals} (raw: ${activity.calories}, kj: ${activity.kilojoules})`);
          if (index === 0) debugLog(`Keys: ${Object.keys(activity).join(', ')}`);
        }

        stats.totalDistance += dist;
        stats.totalTime += time;
        stats.totalElevation += elev;
        stats.totalCalories += cals;
        stats.kudos += activity.kudos_count || 0;
        stats.totalComments += activity.comment_count || 0;
        stats.prs += activity.pr_count || 0;

        // Max/Best tracking
        stats.maxKudos = Math.max(stats.maxKudos, activity.kudos_count || 0);
        stats.longestActivityDist = Math.max(stats.longestActivityDist, dist);
        stats.longestActivityTime = Math.max(stats.longestActivityTime, time);
        stats.maxElevationGain = Math.max(stats.maxElevationGain, elev); // Single biggest climb (approx as total gain)
        stats.hilliestRun = Math.max(stats.hilliestRun, elev);
        stats.maxCalories = Math.max(stats.maxCalories, cals);

        // Activity types
        const type = activity.type || 'Other';
        stats.activityTypes[type] = (stats.activityTypes[type] || 0) + 1;

        // Heart rate
        if (activity.max_heartrate) {
          stats.maxHeartRate = Math.max(stats.maxHeartRate, activity.max_heartrate);
        }
        if (activity.average_heartrate) {
          stats.avgHeartRate += activity.average_heartrate;
          stats.heartRateCount++;
        }

        // Fastest pace & PRs (Simplified logic)
        if (type === 'Run' && dist > 0) {
          const pace = time / (dist / 1000); // sec/km
          stats.fastestKm = Math.min(stats.fastestKm, pace);

          // Rough PR tracking based on distance
          const distKm = dist / 1000;
          if (distKm >= 1.6 && time < stats.fastestPaces['1mi'].time) stats.fastestPaces['1mi'] = { time, date };
          if (distKm >= 5 && time < stats.fastestPaces['5k'].time) stats.fastestPaces['5k'] = { time, date };
          if (distKm >= 10 && time < stats.fastestPaces['10k'].time) stats.fastestPaces['10k'] = { time, date };
          if (distKm >= 21.09 && time < stats.fastestPaces['half'].time) stats.fastestPaces['half'] = { time, date };
          if (distKm >= 42.19 && time < stats.fastestPaces['marathon'].time) stats.fastestPaces['marathon'] = { time, date };
        }

        // Monthly stats
        const month = date.getMonth();
        stats.monthlyDistance[month] += dist;
        stats.monthlyActivities[month]++;

        // Weekly stats
        const weekNum = getWeekNumber(date);
        if (weekNum >= 0 && weekNum < 53) {
          stats.weeklyDistance[weekNum] += dist;
        }

        // Time distribution (5am - 8pm)
        const hour = new Date(activity.start_date_local || activity.start_date).getHours();
        stats.startTimes[hour]++;

        // Map 5am (5) to index 0, 8pm (20) to index 15
        if (hour >= 5 && hour <= 20) {
          stats.timeDistribution[hour - 5]++;
        }

        // Heatmap & Streak
        const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
        // Adjust to 0=Mon, 6=Sun for heatmap usually, but let's stick to JS day
        if (weekNum >= 0 && weekNum < 53) {
          // Simple intensity: 1 activity = 1, >10km = 2, >20km = 3, etc.
          let intensity = 1;
          if (dist > 10000) intensity = 2;
          if (dist > 20000) intensity = 3;
          if (dist > 40000) intensity = 4;
          stats.heatmapData[weekNum][dayOfWeek] = Math.max(stats.heatmapData[weekNum][dayOfWeek], intensity);
        }

        stats.activeDays.add(date.toISOString().split('T')[0]);

        // Unique routes
        if (activity.map && activity.map.summary_polyline) {
          stats.uniqueRoutes.add(activity.map.summary_polyline.substring(0, 20));
        }
      });

      // Post-processing
      if (stats.heartRateCount > 0) {
        stats.avgHeartRate = Math.round(stats.avgHeartRate / stats.heartRateCount);
      }

      // Best month
      stats.monthlyDistance.forEach((dist, i) => {
        if (dist > stats.bestMonth.distance) {
          stats.bestMonth = { index: i, distance: dist, activities: stats.monthlyActivities[i] };
        }
      });

      // Best week
      stats.bestWeekDistance = Math.max(...stats.weeklyDistance);
      stats.avgWeeklyDistance = stats.totalDistance / 52;

      // Streak
      stats.longestStreak = calculateLongestStreak(stats.activeDays);
      stats.currentStreak = calculateCurrentStreak(stats.activeDays);

      // Units conversion
      stats.totalDistanceKm = Math.round(stats.totalDistance / 1000);
      stats.totalTimeHours = Math.round(stats.totalTime / 3600);
      stats.totalElevationKm = (stats.totalElevation / 1000).toFixed(1);
      stats.totalCaloriesK = Math.round(stats.totalCalories / 1000);
      stats.uniqueRoutesCount = stats.uniqueRoutes.size;

      // Calculate total heartbeats (millions)
      const totalMinutes = stats.totalTime / 60;
      const totalBeats = (stats.avgHeartRate || 0) * totalMinutes;
      stats.totalHeartBeatsMillions = (totalBeats / 1000000).toFixed(1);

      // Mini-card formatted values
      stats.formatted = {
        kmPerWeek: (stats.avgWeeklyDistance / 1000).toFixed(1),
        bestWeek: (stats.bestWeekDistance / 1000).toFixed(1),
        longestDist: (stats.longestActivityDist / 1000).toFixed(1),
        avgTimePerActivity: formatDuration(stats.totalTime / stats.totalActivities),
        longestTime: formatDuration(stats.longestActivityTime),
        biggestClimb: Math.round(stats.maxElevationGain) + 'm',
        hilliestRun: Math.round(stats.hilliestRun) + 'm',
        dailyAvgCalories: Math.round(stats.totalCalories / 365),
        maxCalories: Math.round(stats.maxCalories).toLocaleString(),
        activePercent: Math.round((stats.activeDays.size / 365) * 100) + '%',
        morningPercent: Math.round((stats.startTimes.slice(5, 9).reduce((a, b) => a + b, 0) / stats.totalActivities) * 100) + '%',
        earliestStart: getEarliestStart(stats.startTimes)
      };

      // Format fastest pace
      stats.fastestKmFormatted = formatPace(stats.fastestKm);

      // Common start time
      let maxStartTime = 0;
      let commonHour = 6;
      stats.startTimes.forEach((count, hour) => {
        if (count > maxStartTime) {
          maxStartTime = count;
          commonHour = hour;
        }
      });
      const ampm = commonHour >= 12 ? 'PM' : 'AM';
      const displayHour = commonHour % 12 || 12;
      stats.commonStartTime = `${displayHour}:00`;
      stats.commonStartTimeUnit = ampm;

      return stats;
    }

    function formatDuration(seconds) {
      if (!seconds) return '0:00';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}:${m.toString().padStart(2, '0')}` : `${m}m`;
    }

    function formatPace(secondsPerKm) {
      if (secondsPerKm === Infinity || !secondsPerKm) return '--:--';
      const mins = Math.floor(secondsPerKm / 60);
      const secs = Math.round(secondsPerKm % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getEarliestStart(startTimes) {
      // Skip 0-3am (midnight to 3am) unless that's the ONLY time they run.
      // Many manual entries default to midnight.
      let first = -1;
      for (let i = 0; i < 24; i++) {
        if (startTimes[i] > 0) {
          if (first === -1) first = i;
          // If we find something reasonable (>= 4am), return it.
          if (i >= 4) {
            const ampm = i >= 12 ? 'pm' : 'am';
            const h = i % 12 || 12;
            return `${h}${ampm}`;
          }
        }
      }
      // If we only found crazy early times, return the first one
      if (first !== -1) {
        const ampm = first >= 12 ? 'pm' : 'am';
        const h = first % 12 || 12;
        return `${h}${ampm}`;
      }
      return '--';
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function calculateLongestStreak(datesSet) {
      const dates = Array.from(datesSet).sort();
      if (dates.length === 0) return 0;

      let maxStreak = 1;
      let currentStreak = 1;

      for (let i = 1; i < dates.length; i++) {
        const prev = new Date(dates[i - 1]);
        const curr = new Date(dates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);

        if (diff === 1) {
          currentStreak++;
        } else {
          maxStreak = Math.max(maxStreak, currentStreak);
          currentStreak = 1;
        }
      }
      return Math.max(maxStreak, currentStreak);
    }

    function calculateCurrentStreak(datesSet) {
      if (datesSet.size === 0) return 0;

      const dates = Array.from(datesSet).sort();
      const lastDateStr = dates[dates.length - 1];
      const lastDate = new Date(lastDateStr);

      // Check against today in user's local time (approx)
      const now = new Date();
      // Reset times to compare dates only
      now.setHours(0, 0, 0, 0);
      const last = new Date(lastDate);
      last.setHours(0, 0, 0, 0);

      const diffTime = Math.abs(now - last);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // Allow 0 (today) or 1 (yesterday)
      if (diffDays > 1) return 0;

      let currentStreak = 1;
      for (let i = dates.length - 1; i > 0; i--) {
        const curr = new Date(dates[i]);
        const prev = new Date(dates[i - 1]);

        // Normalize to midnight UTC to avoid DST issues
        curr.setUTCHours(0, 0, 0, 0);
        prev.setUTCHours(0, 0, 0, 0);

        const diff = (curr - prev) / (1000 * 60 * 60 * 24);

        if (Math.round(diff) === 1) {
          currentStreak++;
        } else {
          break;
        }
      }
      return currentStreak;
    }

    function updateUIWithStats(stats) {
      if (athleteData) {
        const nameEl = document.querySelector('.intro-name');
        if (nameEl) nameEl.textContent = `${athleteData.firstname}'s Athletic Journey`;
      }

      // Main Counters
      updateCounter('[data-index="1"] .counter', stats.totalDistanceKm);
      updateCounter('[data-index="2"] .counter', stats.totalTimeHours);
      updateCounter('[data-index="3"] .counter', stats.totalElevationKm);
      updateCounter('[data-index="4"] .counter', stats.totalHeartBeatsMillions);
      updateCounter('[data-index="5"] .counter', stats.totalCaloriesK);
      updateCounter('[data-index="6"] .counter', stats.totalActivities);
      updateCounter('[data-index="7"] .counter', stats.longestStreak);
      updateCounter('[data-index="9"] .counter', stats.kudos);
      updateCounter('[data-index="10"] .counter', stats.uniqueRoutesCount);
      updateCounter('[data-index="12"] .counter', stats.prs);

      // Distance Card Mini-stats
      updateMiniCard('.card-distance', 0, stats.formatted.kmPerWeek);
      updateMiniCard('.card-distance', 1, stats.formatted.bestWeek);
      updateMiniCard('.card-distance', 2, stats.formatted.longestDist);

      // Time Card Mini-stats
      updateMiniCard('.card-time', 0, stats.formatted.avgTimePerActivity);
      updateMiniCard('.card-time', 1, stats.formatted.longestTime);

      // Elevation Card Mini-stats
      updateMiniCard('.card-elevation', 0, stats.formatted.biggestClimb);
      updateMiniCard('.card-elevation', 1, stats.formatted.hilliestRun);

      // Heart Rate Card
      updateMiniCard('.card-heartrate', 0, stats.maxHeartRate);
      updateMiniCard('.card-heartrate', 1, stats.avgHeartRate);
      // Resting HR is not available in summary activities. 
      // Replacing with "Zones" placeholder or removing. Let's change label to "Activities with HR"
      updateMiniCard('.card-heartrate', 2, stats.heartRateCount);
      const hrCard = document.querySelector('.card-heartrate');
      if (hrCard) {
        const labels = hrCard.querySelectorAll('.mini-card-label');
        if (labels[2]) labels[2].textContent = 'Recorded';
      }

      // Calories Card
      // Calculate daily average based on active days, not 365, to be more representative of "workout days"
      // Or just total / 365 if we want true daily average. 
      // User said "wrong" (161). 58k total. 
      // Let's change it to "Avg per Activity" which is more accurate/verifiable.
      updateMiniCard('.card-calories', 0, Math.round(stats.totalCalories / stats.totalActivities));
      // Update label
      const calCard = document.querySelector('.card-calories');
      if (calCard) {
        const labels = calCard.querySelectorAll('.mini-card-label');
        if (labels[0]) labels[0].textContent = 'Avg / Activity';
      }
      updateMiniCard('.card-calories', 1, stats.formatted.maxCalories);

      // Activities Card (Breakdown)
      updateActivityBreakdown(stats.activityTypes);

      // Streak Card
      updateMiniCard('.card-streak', 0, stats.currentStreak);
      updateMiniCard('.card-streak', 1, stats.formatted.activePercent);

      // Pace Card - REMOVE Fastest Km
      // User asked to remove "fastest kilometer card". 
      // We'll replace the main stat with "Fastest 5k" if available, or just "Best Pace"
      const paceEl = document.querySelector('[data-index="8"] .stat-huge');
      if (paceEl) {
        if (stats.fastestPaces['5k'].time !== Infinity) {
          paceEl.innerHTML = formatDuration(stats.fastestPaces['5k'].time);
          const label = document.querySelector('[data-index="8"] .label');
          if (label) label.textContent = 'Fastest 5k';
        } else {
          paceEl.innerHTML = '--:--';
        }
      }

      // Update PR mini-cards
      updateMiniCard('.card-pace', 0, formatDuration(stats.fastestPaces['1mi'].time));
      updateMiniCard('.card-pace', 1, formatDuration(stats.fastestPaces['5k'].time));
      updateMiniCard('.card-pace', 2, formatDuration(stats.fastestPaces['10k'].time));
      updateMiniCard('.card-pace', 3, formatDuration(stats.fastestPaces['half'].time));
      updateMiniCard('.card-pace', 4, formatDuration(stats.fastestPaces['marathon'].time));

      // Kudos Card
      updateMiniCard('.card-kudos', 0, (stats.kudos / stats.totalActivities).toFixed(1));
      updateMiniCard('.card-kudos', 1, stats.maxKudos);
      updateMiniCard('.card-kudos', 2, stats.totalComments);

      // Update label for the 3rd card since we changed it from Given to Comments
      const kudosCard = document.querySelector('.card-kudos');
      if (kudosCard) {
        const labels = kudosCard.querySelectorAll('.mini-card-label');
        if (labels[2]) labels[2].textContent = 'comments';
      }

      // Routes Card
      // (Placeholders for now as we don't have segment data)

      // Morning Card
      const timeEl = document.querySelector('[data-index="11"] .stat-huge');
      if (timeEl) timeEl.innerHTML = `${stats.commonStartTime}<span class="stat-unit">${stats.commonStartTimeUnit}</span>`;
      updateMiniCard('.card-morning', 0, stats.formatted.morningPercent);
      updateMiniCard('.card-morning', 1, stats.formatted.earliestStart);

      // Records Card
      // (Using same PR data as Pace card for now)
      updateMiniCard('.card-records', 0, formatDuration(stats.fastestPaces['1mi'].time));
      updateMiniCard('.card-records', 1, formatDuration(stats.fastestPaces['5k'].time));
      updateMiniCard('.card-records', 2, formatDuration(stats.fastestPaces['10k'].time));
      updateMiniCard('.card-records', 3, formatDuration(stats.fastestPaces['half'].time));
      updateMiniCard('.card-records', 4, formatDuration(stats.fastestPaces['marathon'].time));

      // Best Month Card
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthEl = document.querySelector('[data-index="13"] .stat-huge');
      if (monthEl) monthEl.textContent = months[stats.bestMonth.index];

      updateMiniCard('.card-month', 0, Math.round(stats.bestMonth.distance / 1000));
      updateMiniCard('.card-month', 1, stats.bestMonth.activities);
      updateMiniCard('.card-month', 2, '--'); // PRs per month not tracked yet

      // Summary Grid
      updateSummary(stats);

      // Update Taglines
      updateTaglines(stats);
    }

    function updateTaglines(stats) {
      const taglines = generateTaglines(stats);

      setTagline('.card-distance .context', taglines.distance);
      setTagline('.card-time .context', taglines.time);
      setTagline('.card-elevation .context', taglines.elevation);
      setTagline('.card-heartrate .context', taglines.heartrate);
      setTagline('.card-calories .context', taglines.calories);
      setTagline('.card-activities .context', taglines.activities);
      setTagline('.card-streak .context', taglines.streak);
      setTagline('.card-pace .context', taglines.pace);
      setTagline('.card-kudos .context', taglines.kudos);
      setTagline('.card-routes .context', taglines.routes);
      setTagline('.card-morning .context', taglines.morning);
      setTagline('.card-records .context', taglines.records);
      setTagline('.card-month .context', taglines.month);
    }

    function setTagline(selector, html) {
      const el = document.querySelector(selector);
      if (el && html) el.innerHTML = html;
    }

    function generateTaglines(stats) {
      // Distance
      let distanceTag = '';
      if (stats.totalDistanceKm > 40075) distanceTag = `You circled the <em>entire Earth</em>!`;
      else if (stats.totalDistanceKm > 4500) distanceTag = `That's <em>coast to coast</em> across the USA.`;
      else if (stats.totalDistanceKm > 1000) distanceTag = `That's <em>London to Berlin</em> and back.`;
      else distanceTag = `That's <em>${Math.round(stats.totalDistanceKm / 42.2)} marathons</em> back-to-back.`;

      // Time
      const days = (stats.totalTimeHours / 24).toFixed(1);
      const timeTag = `That's <em>${days} full days</em> of pure motion.`;

      // Elevation
      const everests = (stats.totalElevationKm * 1000 / 8848).toFixed(1);
      const elevationTag = `You climbed <em>${everests}x the height of Everest</em>.`;

      // Heart Rate
      const hrTag = `Your heart beat <em>${stats.totalHeartBeatsMillions} million times</em> during workouts.`;

      // Calories
      const pizzas = Math.round(stats.totalCalories / 285); // Slice of pizza
      const calsTag = `That's <em>${pizzas.toLocaleString()} slices of pizza</em> worth of energy.`;

      // Activities
      const avgPerWeek = (stats.totalActivities / 52).toFixed(1);
      const restDays = 365 - stats.activeDays.size;
      const activitiesTag = `That's <em>${avgPerWeek} activities per week</em>. ${restDays} rest days.`;

      // Streak
      let streakTag = `Consistency is key. Keep it up!`;
      if (stats.longestStreak > 3) {
        streakTag = `Your longest streak was <em>${stats.longestStreak} days</em>. Relentless.`;
      }

      // Pace
      let paceTag = `Keep pushing your limits.`;
      if (stats.fastestPaces['5k'] && stats.fastestPaces['5k'].date) {
        const d = new Date(stats.fastestPaces['5k'].date);
        const dateStr = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        paceTag = `Fastest 5K on <em>${dateStr}</em>.`;
      }

      // Kudos
      const kudosTag = stats.kudos > 100 ? `You're kind of a <em>big deal</em>.` : `Your community showed up for you.`;

      // Routes
      const routesTag = `You explored <em>${stats.uniqueRoutesCount} unique paths</em> this year.`;

      // Morning
      const hour = stats.commonStartHour || 0;
      let morningTag = `You love a lunch run.`;
      if (hour < 5) morningTag = `You're a <em>night owl</em> (or very early bird).`;
      else if (hour < 10) morningTag = `You're an <em>early bird</em>.`;
      else if (hour >= 17) morningTag = `You own the <em>night</em>.`;

      // Records
      const recordsTag = `A year of <em>${stats.prs} personal records</em>.`;

      // Month
      const monthTag = `You were <em>on fire</em> in ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][stats.bestMonth.index]}.`;

      return {
        distance: distanceTag,
        time: timeTag,
        elevation: elevationTag,
        heartrate: hrTag,
        calories: calsTag,
        activities: activitiesTag,
        streak: streakTag,
        pace: paceTag,
        kudos: kudosTag,
        routes: routesTag,
        morning: morningTag,
        records: recordsTag,
        month: monthTag
      };
    }

    function updateMiniCard(cardSelector, index, value) {
      const card = document.querySelector(cardSelector);
      if (!card) return;
      const minis = card.querySelectorAll('.mini-card');
      if (minis[index]) {
        const valEl = minis[index].querySelector('.mini-card-value');
        if (valEl) valEl.textContent = value;
      }
    }

    function updateCounter(selector, value) {
      const el = document.querySelector(selector);
      if (el) el.dataset.target = value;
    }

    function updateActivityBreakdown(types) {
      const typeMap = {
        'Run': { emoji: 'üèÉ', name: 'Runs' },
        'Ride': { emoji: 'üö¥', name: 'Rides' },
        'Swim': { emoji: 'üèä', name: 'Swims' },
        'Walk': { emoji: 'üö∂', name: 'Walks' },
        'Hike': { emoji: 'ü•æ', name: 'Hikes' },
        'WeightTraining': { emoji: 'üí™', name: 'Weights' },
        'Workout': { emoji: 'üí™', name: 'Workouts' },
        'Yoga': { emoji: 'üßò', name: 'Yoga' }
      };

      const grid = document.querySelector('.activity-grid');
      if (!grid) return;

      const sortedTypes = Object.entries(types)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 4);

      grid.innerHTML = sortedTypes.map(([type, count]) => {
        const info = typeMap[type] || { emoji: 'üëü', name: type };
        return `
          <div class="activity-item">
            <div class="activity-emoji">${info.emoji}</div>
            <div class="activity-count">${count}</div>
            <div class="activity-name">${info.name}</div>
          </div>
        `;
      }).join('');
    }

    function updateSummary(stats) {
      const summaryValues = document.querySelectorAll('.summary-num');
      if (summaryValues.length >= 7) {
        summaryValues[0].textContent = `${stats.totalDistanceKm.toLocaleString()} km`;
        summaryValues[1].textContent = stats.totalActivities;
        summaryValues[2].textContent = `${stats.totalTimeHours} hrs`;
        summaryValues[3].textContent = `${stats.totalElevationKm} km`;
        summaryValues[4].textContent = `${stats.totalCaloriesK}k`;
        summaryValues[5].textContent = stats.prs;
        summaryValues[6].textContent = stats.longestStreak;
      }
    }

    function createHeatmap(data) {
      const container = document.getElementById('heatmap');
      container.innerHTML = ''; // Clear demo data

      // Data is 53 weeks x 7 days
      for (let week = 0; week < 52; week++) {
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';

          const intensity = data && data[week] ? data[week][day] : 0;
          if (intensity > 0) cell.classList.add(`l${Math.min(intensity, 4)}`);

          container.appendChild(cell);
        }
      }
    }

    function createTimeBars(data) {
      const container = document.getElementById('timeBars');
      container.innerHTML = '';

      // Data is array of 16 hours (5am - 8pm)
      const max = Math.max(...data, 1);

      data.forEach((count, i) => {
        const bar = document.createElement('div');
        bar.className = 'time-bar';
        const height = Math.max((count / max) * 100, 5); // Min 5% height
        bar.style.height = height + '%';
        if (count === max && count > 0) bar.classList.add('peak');
        container.appendChild(bar);
      });
    }

    function createMonthBars(monthlyDistances) {
      const container = document.getElementById('monthBars');
      if (!container) return; // Might not exist in DOM yet if I missed it
      container.innerHTML = '';

      const months = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
      const max = Math.max(...monthlyDistances, 1);

      months.forEach((m, i) => {
        const val = monthlyDistances[i];
        const col = document.createElement('div');
        col.className = 'month-col';

        const bar = document.createElement('div');
        bar.className = 'month-bar' + (val === max && val > 0 ? ' best' : '');
        bar.style.height = Math.max((val / max) * 100, 5) + '%';

        const label = document.createElement('div');
        label.className = 'month-name';
        label.textContent = m;

        col.appendChild(bar);
        col.appendChild(label);
        container.appendChild(col);
      });
    }

    let emojiInterval;
    const emojis = ['üèÉ', 'üö¥', 'üèä', 'üö∂', 'ü•æ', 'üí™', 'üßò', '‚õ∑Ô∏è'];

    function showLoading(text) {
      document.getElementById('loadingScreen').classList.remove('hidden');
      hideLogin(); // Explicitly hide login screen
      document.getElementById('loadingSubtext').textContent = text || 'Loading...';

      // Start emoji cycling
      if (emojiInterval) clearInterval(emojiInterval);
      let i = 0;
      const el = document.getElementById('emojiCycler');
      emojiInterval = setInterval(() => {
        el.textContent = emojis[i];
        i = (i + 1) % emojis.length;
      }, 500);
    }

    function updateLoadingText(text) {
      document.getElementById('loadingSubtext').textContent = text;
    }

    function hideLoading() {
      document.getElementById('loadingScreen').classList.add('hidden');
      if (emojiInterval) clearInterval(emojiInterval);
    }

    function hideLogin() {
      document.getElementById('loginScreen').classList.add('hidden');
    }

    function loadDemoData() {
      hideLogin();
      init();
    }

    // Check for OAuth callback or existing session
    function checkAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        // Clear the URL
        window.history.replaceState({}, document.title, window.location.pathname);
        exchangeToken(code);
      } else {
        const token = localStorage.getItem('strava_access_token');
        if (token) {
          debugLog('Found existing token, fetching activities...');
          showLoading('Welcome back! Fetching your year...');
          athleteData = JSON.parse(localStorage.getItem('strava_athlete') || 'null');
          fetchAllActivities(token);
        } else {
          debugLog('No token found, showing login.');
        }
      }
    }

    // Debug Logger
    function debugLog(msg) {
      const log = document.getElementById('debugLog');
      if (log) {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
      }
      console.log(msg);
    }

    // Run auth check on load
    debugLog('App started. Checking auth...');
    checkAuth();
  </script>
</body>

</html>