<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Year In Motion</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÑ</text></svg>">

  <link
    href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=Instrument+Serif:ital@0;1&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --orange-hot: #FF4D00;
      --coral: #FF7F6B;
      --peach: #FFB199;
      --cream: #FFF8F0;
      --night: #0A0A0A;
      --gold: #FFD700;
      --electric-blue: #00D4FF;
      --mint: #00FFB2;
      --violet: #8B5CF6;
      --rose: #FF3366;
      --strava-orange: #FC4C02;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--night);
      color: var(--cream);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      -webkit-font-smoothing: antialiased;
    }

    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: calc(40px + env(safe-area-inset-top, 0))
               max(40px, env(safe-area-inset-right, 40px))
               calc(40px + env(safe-area-inset-bottom, 0))
               max(40px, env(safe-area-inset-left, 40px));
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .login-screen::before {
      content: '';
      position: absolute;
      top: calc(-1 * env(safe-area-inset-top, 0));
      left: calc(-1 * env(safe-area-inset-left, 0));
      right: calc(-1 * env(safe-area-inset-right, 0));
      bottom: calc(-1 * env(safe-area-inset-bottom, 0));
      background: var(--night);
      z-index: -1;
    }

    .login-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .login-logo {
      font-family: 'Teko', sans-serif;
      font-size: clamp(3rem, 12vw, 6rem);
      font-weight: 700;
      transform: skewX(-6deg);
      background: linear-gradient(180deg, var(--cream) 20%, var(--peach) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      font-style: italic;
      opacity: 0.7;
      margin-bottom: 48px;
    }

    .login-description {
      max-width: 400px;
      text-align: center;
      font-size: 1rem;
      opacity: 0.6;
      line-height: 1.6;
      margin-bottom: 40px;
    }

    .strava-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 16px 32px;
      background: var(--strava-orange);
      color: white;
      border: none;
      border-radius: 100px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .strava-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 40px rgba(252, 76, 2, 0.4);
    }

    .strava-btn svg {
      width: 24px;
      height: 24px;
    }

    .demo-link {
      margin-top: 24px;
      font-size: 0.85rem;
      opacity: 0.5;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .demo-link:hover {
      opacity: 0.8;
    }

    /* Settings Button on Login Screen */
    .settings-btn {
      position: absolute;
      top: calc(20px + env(safe-area-inset-top, 0));
      right: calc(20px + env(safe-area-inset-right, 0));
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--cream);
      opacity: 0.6;
    }

    .settings-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.15);
      transform: rotate(45deg);
    }

    /* Onboarding Screen */
    .onboarding-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      /* Extend into iOS safe areas */
      padding-top: env(safe-area-inset-top, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);
      padding-left: max(24px, env(safe-area-inset-left, 24px));
      padding-right: max(24px, env(safe-area-inset-right, 24px));
      z-index: 2003;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
      overflow-y: auto;
    }

    .onboarding-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .onboarding-gradient {
      position: absolute;
      /* Extend beyond safe areas to fill entire screen */
      top: calc(-1 * env(safe-area-inset-top, 0));
      left: calc(-1 * env(safe-area-inset-left, 0));
      right: calc(-1 * env(safe-area-inset-right, 0));
      bottom: calc(-1 * env(safe-area-inset-bottom, 0));
      background: var(--night);
      pointer-events: none;
    }

    .onboarding-gradient::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(255, 77, 0, 0.15) 0%, transparent 60%),
                  radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
    }

    .onboarding-progress {
      position: fixed;
      top: calc(24px + env(safe-area-inset-top, 0));
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: var(--strava-orange);
      width: 24px;
      border-radius: 4px;
    }

    .progress-dot.completed {
      background: var(--mint);
    }

    .onboarding-step {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px 24px 24px;
      opacity: 0;
      visibility: hidden;
      transform: translateX(30px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }

    .onboarding-step.active {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .onboarding-step.exiting {
      opacity: 0;
      transform: translateX(-30px);
    }

    .onboarding-content {
      max-width: 440px;
      width: 100%;
      text-align: center;
      position: relative;
    }

    .onboarding-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .onboarding-title {
      font-family: 'Teko', sans-serif;
      font-size: clamp(2.5rem, 10vw, 3.5rem);
      font-weight: 700;
      line-height: 0.95;
      transform: skewX(-4deg);
      background: linear-gradient(180deg, var(--cream) 20%, var(--peach) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .onboarding-subtitle {
      font-family: 'Instrument Serif', serif;
      font-size: 1.2rem;
      font-style: italic;
      opacity: 0.7;
      margin-bottom: 20px;
    }

    .onboarding-info {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .info-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 255, 178, 0.1);
      border: 1px solid rgba(0, 255, 178, 0.2);
      color: var(--mint);
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .onboarding-description {
      font-size: 1rem;
      opacity: 0.6;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .onboarding-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 32px;
      border: none;
      border-radius: 100px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .onboarding-btn.primary {
      background: var(--strava-orange);
      color: white;
    }

    .onboarding-btn.primary:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 10px 40px rgba(252, 76, 2, 0.4);
    }

    .onboarding-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .back-btn {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: none;
      color: var(--cream);
      opacity: 0.6;
      font-family: 'Outfit', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 8px 0;
      transition: opacity 0.2s ease;
    }

    .back-btn:hover {
      opacity: 1;
    }

    .step-indicator {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.4;
      margin-bottom: 8px;
    }

    /* Instructions Card */
    .instructions-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: left;
    }

    .instruction-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .instruction-item:last-child {
      margin-bottom: 0;
    }

    .instruction-number {
      width: 24px;
      height: 24px;
      min-width: 24px;
      background: var(--strava-orange);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .instruction-text {
      font-size: 0.95rem;
      line-height: 1.5;
      padding-top: 2px;
    }

    .external-link {
      color: var(--electric-blue);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .external-link:hover {
      text-decoration: underline;
    }

    .form-example {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0 16px 36px;
    }

    .form-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.85rem;
    }

    .form-field:last-child {
      border-bottom: none;
    }

    .form-field.highlight {
      background: rgba(252, 76, 2, 0.1);
      border: 1px solid rgba(252, 76, 2, 0.3);
      border-radius: 8px;
      margin: 8px -8px -4px;
      padding: 10px 8px;
    }

    .field-label {
      opacity: 0.6;
    }

    .field-value {
      font-weight: 500;
    }

    .field-value.important {
      color: var(--strava-orange);
      font-weight: 700;
    }

    .field-hint {
      opacity: 0.4;
      font-weight: 400;
      font-style: italic;
    }

    /* Credentials Form */
    .credentials-form {
      text-align: left;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      color: var(--cream);
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--strava-orange);
      box-shadow: 0 0 0 3px rgba(252, 76, 2, 0.2);
    }

    .input-group input::placeholder {
      color: rgba(255, 248, 240, 0.3);
    }

    .input-hint {
      display: block;
      font-size: 0.75rem;
      opacity: 0.4;
      margin-top: 6px;
    }

    .validation-feedback {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--mint);
      font-size: 0.8rem;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(-4px);
      transition: all 0.3s ease;
    }

    .validation-feedback:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
    }

    .privacy-note {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 100px;
      padding: 10px 16px;
      font-size: 0.8rem;
      opacity: 0.6;
      margin-bottom: 24px;
    }

    /* Success Animation */
    .success-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      margin-bottom: 24px;
    }

    .success-checkmark svg {
      width: 100%;
      height: 100%;
    }

    .checkmark-circle {
      stroke: var(--mint);
      stroke-width: 2;
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark-check {
      stroke: var(--mint);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.5s forwards;
    }

    @keyframes stroke {
      100% { stroke-dashoffset: 0; }
    }

    /* Settings Modal */
    .settings-modal {
      position: fixed;
      inset: 0;
      z-index: 3000;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .settings-modal.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .settings-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }

    .settings-card {
      position: relative;
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      overflow: hidden;
      transform: scale(0.95);
      opacity: 0;
      animation: modalIn 0.3s ease forwards;
    }

    @keyframes modalIn {
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .settings-header h2 {
      font-family: 'Teko', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .close-btn {
      background: transparent;
      border: none;
      color: var(--cream);
      opacity: 0.6;
      cursor: pointer;
      padding: 4px;
      transition: opacity 0.2s ease;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .settings-content {
      padding: 24px;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
      margin-bottom: 12px;
    }

    .credential-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .credential-label {
      opacity: 0.6;
    }

    .credential-value {
      font-family: monospace;
      font-weight: 500;
    }

    .settings-action-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.9rem;
      color: var(--cream);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .settings-action-btn.danger {
      color: var(--rose);
      border-color: rgba(255, 51, 102, 0.2);
    }

    .settings-action-btn.danger:hover {
      background: rgba(255, 51, 102, 0.1);
    }

    /* Credential Error Screen */
    .credential-error-screen {
      position: fixed;
      inset: 0;
      z-index: 2004;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      background: var(--night);
      text-align: center;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .credential-error-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .onboarding-content {
        padding: 0 8px;
      }

      .onboarding-title {
        font-size: 2.2rem;
      }

      .instructions-card {
        padding: 16px;
      }

      .form-example {
        margin-left: 0;
        margin-top: 16px;
      }

      .form-field {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .settings-card {
        width: 95%;
        margin: 0 10px;
      }
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2001;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: calc(40px + env(safe-area-inset-top, 0))
               max(40px, env(safe-area-inset-right, 40px))
               calc(40px + env(safe-area-inset-bottom, 0))
               max(40px, env(safe-area-inset-left, 40px));
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-screen::before {
      content: '';
      position: absolute;
      top: calc(-1 * env(safe-area-inset-top, 0));
      left: calc(-1 * env(safe-area-inset-left, 0));
      right: calc(-1 * env(safe-area-inset-right, 0));
      bottom: calc(-1 * env(safe-area-inset-bottom, 0));
      background: var(--night);
      z-index: -1;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .emoji-cycler {
      font-size: 4rem;
      margin-bottom: 24px;
      animation: bounce 1s infinite alternate;
    }

    @keyframes bounce {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-10px);
      }
    }

    .loading-progress-container {
      width: 200px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 16px;
    }

    .loading-progress-bar {
      height: 100%;
      width: 0%;
      background: var(--strava-orange);
      border-radius: 3px;
      transition: width 0.3s ease;
      animation: progressIndeterminate 2s infinite linear;
    }

    @keyframes progressIndeterminate {
      0% {
        width: 0%;
        transform: translateX(-100%);
      }

      50% {
        width: 50%;
      }

      100% {
        width: 100%;
        transform: translateX(100%);
      }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 24px;
      letter-spacing: 0.05em;
    }

    .loading-subtext {
      font-size: 0.9rem;
      opacity: 0.5;
      margin-top: 8px;
    }

    /* Error Screen */
    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2002;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: calc(40px + env(safe-area-inset-top, 0))
               max(40px, env(safe-area-inset-right, 40px))
               calc(40px + env(safe-area-inset-bottom, 0))
               max(40px, env(safe-area-inset-left, 40px));
      background: var(--night);
      transition: opacity 0.5s ease, visibility 0.5s ease;
      text-align: center;
    }

    .error-screen::before {
      content: '';
      position: absolute;
      top: calc(-1 * env(safe-area-inset-top, 0));
      left: calc(-1 * env(safe-area-inset-left, 0));
      right: calc(-1 * env(safe-area-inset-right, 0));
      bottom: calc(-1 * env(safe-area-inset-bottom, 0));
      background: var(--night);
      z-index: -1;
    }

    .error-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .error-title {
      font-family: 'Teko', sans-serif;
      font-size: clamp(3rem, 10vw, 5rem);
      font-weight: 700;
      line-height: 0.9;
      margin-bottom: 24px;
      transform: skewX(-6deg);
      background: linear-gradient(180deg, var(--rose) 20%, var(--orange-hot) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .error-message {
      font-size: 1.1rem;
      opacity: 0.8;
      max-width: 500px;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .error-note {
      font-size: 0.9rem;
      opacity: 0.5;
      font-style: italic;
      font-family: 'Instrument Serif', serif;
    }

    /* Wrapped content wrapper */
    .wrapped-content {
      transition: opacity 0.5s ease;
    }

    .wrapped-content.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .gradient-spotlight {
      position: fixed;
      top: calc(-1 * env(safe-area-inset-top, 0));
      left: calc(-1 * env(safe-area-inset-left, 0));
      right: calc(-1 * env(safe-area-inset-right, 0));
      bottom: calc(-1 * env(safe-area-inset-bottom, 0));
      z-index: 0;
      background: var(--base-color, #0a0a0a);
      overflow: hidden;
      transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gradient-spotlight::before,
    .gradient-spotlight::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gradient-spotlight::before {
      width: 140vmax;
      height: 140vmax;
      background: radial-gradient(circle, var(--spot-color-1, var(--orange-hot)) 0%, transparent 60%);
      top: var(--spot-y-1, 20%);
      left: var(--spot-x-1, 60%);
      transform: translate(-50%, -50%);
      opacity: 0.8;
    }

    .gradient-spotlight::after {
      width: 120vmax;
      height: 120vmax;
      background: radial-gradient(circle, var(--spot-color-2, var(--violet)) 0%, transparent 55%);
      top: var(--spot-y-2, 60%);
      left: var(--spot-x-2, 10%);
      transform: translate(-50%, -50%);
      opacity: 0.7;
    }

    .progress-container {
      position: fixed;
      top: calc(16px + env(safe-area-inset-top, 0));
      left: calc(16px + env(safe-area-inset-left, 0));
      right: calc(16px + env(safe-area-inset-right, 0));
      display: flex;
      gap: 4px;
      z-index: 1000;
    }

    .progress-bar {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }

    .progress-bar.completed .progress-fill {
      width: 100%;
    }

    .progress-bar.active .progress-fill {
      animation: progress 7.5s linear forwards;
    }

    .progress-fill {
      height: 100%;
      background: var(--cream);
      width: 0;
      border-radius: 3px;
    }

    @keyframes progress {
      to {
        width: 100%;
      }
    }

    .nav-area {
      position: fixed;
      top: calc(50px + env(safe-area-inset-top, 0));
      bottom: env(safe-area-inset-bottom, 0);
      width: 25%;
      z-index: 100;
      cursor: pointer;
    }

    .nav-area.left {
      left: env(safe-area-inset-left, 0);
    }

    .nav-area.right {
      right: env(safe-area-inset-right, 0);
    }

    .story-card {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      overflow: hidden;
      transform: scale(0.96);
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        visibility 0.6s;
    }

    .story-card.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .story-card.exiting {
      opacity: 0;
      transform: scale(1.04);
    }

    .hero-section {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: calc(40px + env(safe-area-inset-top, 0))
               calc(24px + env(safe-area-inset-right, 0))
               calc(40px + env(safe-area-inset-bottom, 0))
               calc(24px + env(safe-area-inset-left, 0));
      position: relative;
    }

    .mini-cards-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
      max-width: 400px;
    }

    .mini-card {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      min-width: 85px;
      flex: 1;
      max-width: 120px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(16px) scale(0.95);
    }



    .mini-card.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .mini-card:nth-child(1) {
      transition: opacity 0.4s ease 1.0s, transform 0.4s ease 1.0s;
    }

    .mini-card:nth-child(2) {
      transition: opacity 0.4s ease 1.1s, transform 0.4s ease 1.1s;
    }

    .mini-card:nth-child(3) {
      transition: opacity 0.4s ease 1.2s, transform 0.4s ease 1.2s;
    }

    .mini-card:nth-child(4) {
      transition: opacity 0.4s ease 1.3s, transform 0.4s ease 1.3s;
    }

    .mini-card:nth-child(5) {
      transition: opacity 0.4s ease 1.4s, transform 0.4s ease 1.4s;
    }

    .mini-card:nth-child(6) {
      transition: opacity 0.4s ease 1.5s, transform 0.4s ease 1.5s;
    }

    .mini-card-icon {
      font-size: 1.4rem;
      line-height: 1;
      margin-bottom: 4px;
    }

    .mini-card-value {
      font-family: 'Teko', sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      line-height: 1;
      transform: skewX(-6deg);
      display: inline-block;
    }

    .mini-card-label {
      font-size: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      opacity: 0.5;
      margin-top: 4px;
      white-space: nowrap;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pr-cards-row {
      max-width: 500px;
    }

    .pr-cards-row .mini-card {
      min-width: 70px;
      max-width: 95px;
      padding: 10px 12px;
    }

    .pr-cards-row .mini-card-value {
      font-size: 1.2rem;
    }

    .stat-content,
    .intro-content,
    .summary-wrap {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.5s ease 0.2s, transform 0.5s ease 0.2s;
    }

    .story-card.active .stat-content,
    .story-card.active .intro-content,
    .story-card.active .summary-wrap {
      opacity: 1;
      transform: translateY(0);
    }

    .story-card.active .mini-card {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .noise {
      position: absolute;
      inset: 0;
      opacity: 0.035;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }

    .grid-overlay {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
      background-size: 80px 80px;
      pointer-events: none;
    }

    .glow {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      pointer-events: none;
      opacity: 0.5;
    }

    .card-intro,
    .card-distance,
    .card-time,
    .card-elevation,
    .card-heartrate,
    .card-calories,
    .card-activities,
    .card-streak,
    .card-kudos,
    .card-routes,
    .card-morning,
    .card-records,
    .card-month {
      background: transparent;
    }

    .card-summary {
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .glow {
      display: none;
    }

    .label {
      font-size: clamp(0.65rem, 1.2vw, 0.8rem);
      text-transform: uppercase;
      letter-spacing: 0.25em;
      opacity: 0.5;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .stat-huge {
      font-family: 'Teko', sans-serif;
      font-size: clamp(5rem, 24vw, 18rem);
      font-weight: 700;
      line-height: 0.85;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
    }

    .stat-unit {
      font-family: 'Teko', sans-serif;
      font-size: clamp(1.5rem, 5vw, 3.5rem);
      font-weight: 500;
      opacity: 0.7;
      margin-left: 8px;
      transform: skewX(-6deg);
      display: inline-block;
      letter-spacing: 0.04em;
    }

    .context {
      font-size: clamp(0.95rem, 2.2vw, 1.25rem);
      font-weight: 400;
      line-height: 1.7;
      max-width: 480px;
      text-align: center;
      margin-top: 28px;
      opacity: 0.8;
    }

    .context em {
      font-family: 'Instrument Serif', serif;
      font-style: italic;
      color: var(--peach);
    }

    .highlight {
      color: var(--gold);
      font-weight: 600;
    }

    .intro-bg {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 50%, rgba(255, 77, 0, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 60% 80% at 30% 70%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse 70% 60% at 70% 30%, rgba(255, 51, 102, 0.1) 0%, transparent 50%);
      animation: introBreath 8s ease-in-out infinite;
    }

    @keyframes introBreath {

      0%,
      100% {
        opacity: 0.8;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    .intro-content {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .intro-label {
      font-size: clamp(0.7rem, 1.5vw, 0.85rem);
      letter-spacing: 0.35em;
      text-transform: uppercase;
      opacity: 0.5;
      margin-bottom: 24px;
    }

    .intro-year {
      font-family: 'Teko', sans-serif;
      font-size: clamp(6rem, 28vw, 18rem);
      font-weight: 700;
      line-height: 0.85;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
      background: linear-gradient(180deg, var(--cream) 20%, var(--peach) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .intro-wrapped {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(2rem, 9vw, 6rem);
      font-style: italic;
      margin-top: -5px;
      opacity: 0.85;
    }

    .intro-name {
      font-size: clamp(0.85rem, 2vw, 1.1rem);
      margin-top: 48px;
      opacity: 0.4;
      letter-spacing: 0.1em;
    }

    .tap-hint {
      position: absolute;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      opacity: 0.35;
      text-transform: uppercase;
    }

    .tap-hint::after {
      content: ' ‚Üí';
      animation: nudge 1.5s ease-in-out infinite;
      display: inline-block;
    }

    .stat-content {
      text-align: center;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .distance-visual {
      position: absolute;
      bottom: 12%;
      left: 0;
      right: 0;
      height: 3px;
      overflow: hidden;
    }

    .distance-line {
      height: 100%;
      background: linear-gradient(90deg, transparent 0%, var(--electric-blue) 20%, var(--mint) 50%, var(--gold) 80%, transparent 100%);
      animation: distanceMove 3s linear infinite;
    }

    @keyframes distanceMove {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .mountain-silhouette {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 35%;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 178, 0.08) 100%);
      clip-path: polygon(0% 100%, 5% 85%, 12% 90%, 20% 65%, 28% 80%, 38% 45%, 45% 60%, 55% 25%, 65% 50%, 72% 35%, 80% 55%, 88% 40%, 95% 70%, 100% 55%, 100% 100%);
    }

    .heartbeat-container {
      position: absolute;
      bottom: 18%;
      left: 0;
      right: 0;
      height: 60px;
      overflow: hidden;
      opacity: 0.5;
    }

    .heartbeat-svg {
      width: 200%;
      height: 100%;
      animation: heartScroll 3s linear infinite;
    }

    @keyframes heartScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-50%);
      }
    }

    .flame-glow {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 200px;
      background: radial-gradient(ellipse at center bottom, var(--orange-hot) 0%, transparent 70%);
      filter: blur(40px);
      opacity: 0.4;
      animation: flameFlicker 2s ease-in-out infinite;
    }

    @keyframes flameFlicker {

      0%,
      100% {
        opacity: 0.4;
        transform: translateX(-50%) scaleY(1);
      }

      50% {
        opacity: 0.6;
        transform: translateX(-50%) scaleY(1.1);
      }
    }

    .activity-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-top: 32px;
      width: 100%;
      max-width: 500px;
    }

    .activity-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px 12px;
      text-align: center;
    }

    .activity-emoji {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .activity-count {
      font-family: 'Teko', sans-serif;
      font-size: 1.6rem;
      font-weight: 600;
      transform: skewX(-6deg);
    }

    .activity-name {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
      margin-top: 4px;
    }

    .heatmap-container {
      margin-top: 36px;
      width: 100%;
      max-width: 90vw;
    }

    .heatmap {
      display: grid;
      grid-template-columns: repeat(52, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 2px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 2px;
      background: rgba(255, 255, 255, 0.08);
      transition: transform 0.1s;
    }

    .heatmap-cell:hover {
      transform: scale(1.5);
      z-index: 10;
    }

    .heatmap-cell.l1 {
      background: rgba(255, 77, 0, 0.25);
    }

    .heatmap-cell.l2 {
      background: rgba(255, 77, 0, 0.45);
    }

    .heatmap-cell.l3 {
      background: rgba(255, 77, 0, 0.7);
    }

    .heatmap-cell.l4 {
      background: var(--orange-hot);
      box-shadow: 0 0 6px rgba(255, 77, 0, 0.5);
    }

    .comparison {
      margin-top: 36px;
      width: 100%;
      max-width: 380px;
    }

    .comparison-row {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }

    .comparison-label {
      width: 70px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    .comparison-track {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 3px;
      overflow: hidden;
    }

    .comparison-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .comparison-fill.you {
      background: linear-gradient(90deg, var(--orange-hot), var(--gold));
    }

    .comparison-fill.avg {
      background: rgba(255, 255, 255, 0.25);
    }

    .comparison-value {
      width: 65px;
      text-align: right;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .kudos-field {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .kudos-heart {
      position: absolute;
      font-size: 1.5rem;
      animation: kudosFloat 7s ease-out infinite;
      opacity: 0;
    }

    @keyframes kudosFloat {
      0% {
        transform: translateY(100vh) scale(0.5) rotate(-10deg);
        opacity: 0;
      }

      10% {
        opacity: 0.7;
      }

      90% {
        opacity: 0.7;
      }

      100% {
        transform: translateY(-10vh) scale(1) rotate(10deg);
        opacity: 0;
      }
    }

    .time-distribution {
      margin-top: 32px;
      width: 100%;
      max-width: 450px;
    }

    .time-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      height: 100px;
      gap: 3px;
    }

    .time-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--gold) 0%, var(--orange-hot) 100%);
      border-radius: 2px 2px 0 0;
      opacity: 0.2;
    }

    .time-bar.peak {
      opacity: 1;
      box-shadow: 0 0 16px rgba(255, 215, 0, 0.4);
    }

    .time-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .time-label {
      font-size: 0.6rem;
      opacity: 0.35;
      text-transform: uppercase;
    }

    .records-stack {
      margin-top: 32px;
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .record-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px;
    }

    .record-icon {
      font-size: 1.6rem;
    }

    .record-info {
      flex: 1;
    }

    .record-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    .record-value {
      font-family: 'Teko', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 2px;
      transform: skewX(-6deg);
    }

    .record-date {
      font-size: 0.7rem;
      opacity: 0.4;
    }

    .month-chart-container {
      margin-top: 32px;
      width: 100%;
      max-width: 480px;
    }

    .month-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      height: 130px;
      gap: 6px;
    }

    .month-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .month-bar {
      width: 28px;
      background: linear-gradient(180deg, var(--electric-blue) 0%, var(--mint) 100%);
      border-radius: 4px 4px 0 0;
      opacity: 0.6;
    }

    .month-bar.best {
      background: linear-gradient(180deg, var(--gold) 0%, var(--orange-hot) 100%);
      opacity: 1;
      box-shadow: 0 0 20px rgba(255, 77, 0, 0.4);
    }

    .month-name {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.4;
    }

    .detail-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px 24px;
      text-align: center;
      width: 100%;
      max-width: 320px;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .detail-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    .detail-value {
      font-family: 'Teko', sans-serif;
      font-size: 2.2rem;
      font-weight: 600;
      transform: skewX(-6deg);
      line-height: 1;
    }

    .detail-desc {
      font-size: 0.8rem;
      opacity: 0.6;
      margin-top: 8px;
    }

    .segments-container {
      display: flex;
      gap: 24px;
      margin-top: 28px;
      width: 100%;
      max-width: 600px;
    }

    .segments-section {
      flex: 1;
    }

    .segments-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.6;
      margin-bottom: 12px;
    }

    .segment-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }

    .segment-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .segment-item.crown {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .segment-rank {
      font-family: 'Teko', sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      opacity: 0.4;
      width: 24px;
      text-align: center;
      transform: skewX(-6deg);
    }

    .segment-badge {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .segment-info {
      flex: 1;
      min-width: 0;
    }

    .segment-name {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .segment-meta {
      font-size: 0.65rem;
      opacity: 0.5;
      margin-top: 2px;
    }

    .pr-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 28px;
      width: 100%;
      max-width: 500px;
      justify-content: center;
    }

    .pr-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px;
      padding: 14px 18px;
      text-align: center;
      min-width: 90px;
      flex: 1;
      transition: transform 0.2s, background 0.2s;
    }

    .pr-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .pr-item.featured {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      flex-basis: 100%;
    }

    .pr-distance {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.5;
      margin-bottom: 6px;
    }

    .pr-time {
      font-family: 'Teko', sans-serif;
      font-size: 1.8rem;
      font-weight: 600;
      transform: skewX(-6deg);
      line-height: 1;
    }

    .pr-item.featured .pr-time {
      font-size: 2.2rem;
    }

    .pr-improvement {
      font-size: 0.7rem;
      color: var(--mint);
      margin-top: 6px;
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .segments-container {
        flex-direction: column;
        gap: 20px;
      }
    }

    .summary-wrap {
      width: 100%;
      max-width: 440px;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .summary-year {
      font-family: 'Teko', sans-serif;
      font-size: clamp(4rem, 16vw, 10rem);
      font-weight: 700;
      line-height: 0.9;
      letter-spacing: -0.02em;
      transform: skewX(-6deg);
    }

    .summary-tagline {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(1.1rem, 3.5vw, 1.8rem);
      font-style: italic;
      opacity: 0.85;
      margin-top: 4px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 100%;
    }

    .summary-stat {
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 18px 14px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-stat.wide {
      grid-column: span 3;
      padding: 28px;
    }

    .summary-num {
      font-family: 'Teko', sans-serif;
      font-size: clamp(1.8rem, 6vw, 2.8rem);
      font-weight: 600;
      line-height: 1;
      transform: skewX(-6deg);
    }

    .summary-lbl {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.6;
      margin-top: 6px;
    }

    @media (max-width: 600px) {
      .story-card {
        padding: 50px 20px;
      }

      .activity-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .summary-stat.wide {
        grid-column: span 2;
      }

      .month-bar {
        width: 18px;
      }
    }
  </style>
</head>

<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-logo">2025</div>
    <div class="login-subtitle">Wrapped</div>
    <p class="login-description">
      Connect your Strava account to see a personalized year in review with all your stats, PRs, and achievements.
    </p>
    <button class="strava-btn" onclick="connectStrava()">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169" />
      </svg>
      Connect with Strava
    </button>
    <button class="settings-btn" onclick="showSettings()" title="Settings">
      <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
      </svg>
    </button>
  </div>

  <!-- Onboarding Wizard -->
  <div class="onboarding-screen hidden" id="onboardingScreen">
    <div class="onboarding-gradient"></div>

    <!-- Progress Dots -->
    <div class="onboarding-progress">
      <div class="progress-dot active" data-step="1"></div>
      <div class="progress-dot" data-step="2"></div>
      <div class="progress-dot" data-step="3"></div>
      <div class="progress-dot" data-step="4"></div>
    </div>

    <!-- Step 1: Welcome -->
    <div class="onboarding-step active" id="onboardingStep1">
      <div class="onboarding-content">
        <div class="onboarding-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
        <h1 class="onboarding-title">Your Year in Motion</h1>
        <p class="onboarding-subtitle">Get your personalized 2025 fitness recap in 2 minutes</p>
        <div class="onboarding-info">
          <div class="info-badge">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            <span>100% Private</span>
          </div>
        </div>
        <p class="onboarding-description">
          This app runs entirely in your browser. You'll connect your own Strava API access ‚Äî your data never touches our servers.
        </p>
        <button class="onboarding-btn primary" onclick="nextOnboardingStep()">
          Let's Go
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 2: Create Strava App -->
    <div class="onboarding-step" id="onboardingStep2">
      <div class="onboarding-content">
        <button class="back-btn" onclick="prevOnboardingStep()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Back
        </button>
        <div class="step-indicator">Step 1 of 2</div>
        <h1 class="onboarding-title">Create a Strava API App</h1>
        <p class="onboarding-subtitle">This takes about 60 seconds</p>

        <div class="instructions-card">
          <div class="instruction-item">
            <div class="instruction-number">1</div>
            <div class="instruction-text">
              <span>Go to </span>
              <a href="https://www.strava.com/settings/api" target="_blank" rel="noopener" class="external-link">
                strava.com/settings/api
                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                  <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                </svg>
              </a>
            </div>
          </div>
          <div class="instruction-item">
            <div class="instruction-number">2</div>
            <div class="instruction-text">Fill in the form with any values:</div>
          </div>
          <div class="form-example">
            <div class="form-field">
              <span class="field-label">Application Name</span>
              <span class="field-value">My Recap <span class="field-hint">(or anything)</span></span>
            </div>
            <div class="form-field">
              <span class="field-label">Category</span>
              <span class="field-value">Visualizer</span>
            </div>
            <div class="form-field">
              <span class="field-label">Club</span>
              <span class="field-value"><span class="field-hint">(leave blank)</span></span>
            </div>
            <div class="form-field">
              <span class="field-label">Website</span>
              <span class="field-value">recap.fit</span>
            </div>
            <div class="form-field highlight">
              <span class="field-label">Authorization Callback Domain</span>
              <span class="field-value important">recap.fit</span>
            </div>
          </div>
          <div class="instruction-item">
            <div class="instruction-number">3</div>
            <div class="instruction-text">Click <strong>"Create"</strong></div>
          </div>
        </div>

        <button class="onboarding-btn primary" onclick="nextOnboardingStep()">
          I've Created My App
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 3: Enter Credentials -->
    <div class="onboarding-step" id="onboardingStep3">
      <div class="onboarding-content">
        <button class="back-btn" onclick="prevOnboardingStep()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Back
        </button>
        <div class="step-indicator">Step 2 of 2</div>
        <h1 class="onboarding-title">Copy Your Credentials</h1>
        <p class="onboarding-subtitle">Find these on your Strava API page after creating the app</p>

        <div class="credentials-form">
          <div class="input-group">
            <label for="clientIdInput">Client ID</label>
            <input type="text" id="clientIdInput" placeholder="e.g., 123456" autocomplete="off" inputmode="numeric">
            <span class="input-hint">The numeric ID shown on your app page</span>
          </div>
          <div class="input-group">
            <label for="clientSecretInput">Client Secret</label>
            <input type="password" id="clientSecretInput" placeholder="Your client secret" autocomplete="off">
            <span class="input-hint">The long alphanumeric string</span>
            <div class="validation-feedback hidden" id="secretFeedback">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Looks good!
            </div>
          </div>
        </div>

        <div class="privacy-note">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
          </svg>
          <span>Your credentials are stored only in your browser and never sent to our servers</span>
        </div>

        <button class="onboarding-btn primary" id="saveCredentialsBtn" onclick="saveCredentials()" disabled>
          Save & Connect
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 4: Success -->
    <div class="onboarding-step" id="onboardingStep4">
      <div class="onboarding-content success-content">
        <div class="success-checkmark">
          <svg viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>
        </div>
        <h1 class="onboarding-title">You're All Set!</h1>
        <p class="onboarding-subtitle">Redirecting to Strava login...</p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal hidden" id="settingsModal">
    <div class="settings-overlay" onclick="hideSettings()"></div>
    <div class="settings-card">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="close-btn" onclick="hideSettings()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      <div class="settings-content">
        <div class="settings-section">
          <h3>API Credentials</h3>
          <div class="credential-display">
            <span class="credential-label">Client ID:</span>
            <span class="credential-value" id="displayClientId">Not set</span>
          </div>
          <button class="settings-action-btn" onclick="resetCredentials()">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Reset Credentials
          </button>
        </div>
        <div class="settings-section">
          <h3>Session</h3>
          <button class="settings-action-btn danger" onclick="clearSession()">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            Log Out & Clear Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div class="loading-screen hidden" id="loadingScreen">
    <div class="emoji-cycler" id="emojiCycler">üèÉ</div>
    <div class="loading-text" id="loadingText">Warming up...</div>
    <div class="loading-progress-container">
      <div class="loading-progress-bar"></div>
    </div>
  </div>

  <!-- Error Screen -->
  <div class="error-screen hidden" id="errorScreen">
    <div class="error-title">Hit the Wall</div>
    <p class="error-message">
      We're waiting to expand our API access to support as many athletes as we can.
    </p>
    <p class="error-note">Please check back later.</p>
    <button class="strava-btn" onclick="window.location.reload()"
      style="margin-top: 32px; background: rgba(255,255,255,0.1);">
      Try Again
    </button>
  </div>

  <div class="gradient-spotlight" id="gradientSpotlight"></div>
  <div class="wrapped-content hidden" id="wrappedContent">
    <div class="progress-container" id="progressContainer"></div>
    <div class="nav-area left" onclick="prevCard()"></div>
    <div class="nav-area right" onclick="nextCard()"></div>

    <!-- 0: Intro -->
    <div class="story-card card-intro active" data-index="0">
      <div class="noise"></div>
      <div class="intro-bg"></div>
      <div class="hero-section">
        <div class="intro-content">
          <div class="intro-label">Your Year in Motion</div>
          <div class="intro-year">2025</div>
          <div class="intro-wrapped">Wrapped</div>
          <div class="intro-name">Your Athletic Journey</div>
        </div>
        <div class="tap-hint">Tap to begin</div>
      </div>

    </div>

    <!-- 1: Distance -->
    <div class="story-card card-distance" data-index="1">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Total Distance</div>
          <div class="stat-huge"><span class="counter" data-target="2847">0</span><span class="stat-unit">mi</span>
          </div>
          <div class="context">That's <em>San Francisco to New York</em> and halfway back.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">54.7</div>
              <div class="mini-card-label">mi/week</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">87.3</div>
              <div class="mini-card-label">best week</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">42.2</div>
              <div class="mini-card-label">longest</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 2: Time -->
    <div class="story-card card-time" data-index="2">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Time Moving</div>
          <div class="stat-huge"><span class="counter" data-target="312">0</span><span class="stat-unit">hrs</span>
          </div>
          <div class="context">That's <em>13 full days</em> of pure motion.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">1:02</div>
              <div class="mini-card-label">avg/activity</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">4:12</div>
              <div class="mini-card-label">longest</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 3: Elevation -->
    <div class="story-card card-elevation" data-index="3">
      <div class="noise"></div>
      <div class="mountain-silhouette"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Elevation Gained</div>
          <div class="stat-huge"><span class="counter" data-target="38">0</span><span class="stat-unit">ft</span></div>
          <div class="context">You climbed <em>4.3√ó the height of Everest</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">892m</div>
              <div class="mini-card-label">biggest climb</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">1,247m</div>
              <div class="mini-card-label">hilliest run</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 4: Heart Rate -->
    <div class="story-card card-heartrate" data-index="4">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Heartbeats During Workouts</div>
          <div class="stat-huge"><span class="counter" data-target="2.4">0</span><span class="stat-unit">million</span>
          </div>
          <div class="context">Your heart worked hard for every mile.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">187</div>
              <div class="mini-card-label">max</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">156</div>
              <div class="mini-card-label">avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">-4</div>
              <div class="mini-card-label">resting</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 5: Calories -->
    <div class="story-card card-calories" data-index="5">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Calories Burned</div>
          <div class="stat-huge"><span class="counter" data-target="186">0</span><span class="stat-unit">k</span></div>
          <div class="context">That's <em>743 Big Macs</em> worth of energy.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">510</div>
              <div class="mini-card-label">daily avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">3,847</div>
              <div class="mini-card-label">max</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 6: Activities -->
    <div class="story-card card-activities" data-index="6">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Total Activities</div>
          <div class="stat-huge"><span class="counter" data-target="312">0</span></div>
          <div class="context">That's <em>6 activities per week</em>. Only 53 rest days.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-icon">üèÉ</div>
              <div class="mini-card-value">198</div>
              <div class="mini-card-label">runs</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üö¥</div>
              <div class="mini-card-value">67</div>
              <div class="mini-card-label">rides</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üèä</div>
              <div class="mini-card-value">31</div>
              <div class="mini-card-label">swims</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üí™</div>
              <div class="mini-card-value">16</div>
              <div class="mini-card-label">other</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 7: Streak -->
    <div class="story-card card-streak" data-index="7">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Longest Streak</div>
          <div class="stat-huge"><span class="counter" data-target="47">0</span><span class="stat-unit">days</span>
          </div>
          <div class="context"><span class="highlight">April 3 ‚Üí May 19</span>. <em>Relentless.</em></div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">12</div>
              <div class="mini-card-label">current</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">85%</div>
              <div class="mini-card-label">active</div>
            </div>
          </div>
          <div class="heatmap-container" style="margin-top: 24px; max-width: 100%;">
            <div class="heatmap" id="heatmap"></div>
          </div>
        </div>
      </div>

    </div>



    <!-- 9: Kudos -->
    <div class="story-card card-kudos" data-index="8">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="kudos-field" id="kudosField"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Kudos Received</div>
          <div class="stat-huge"><span class="counter" data-target="0">0</span></div>
          <div class="context">Your community showed up for you.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">avg</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">best</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">comments</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 10: Routes & Segments -->
    <div class="story-card card-routes" data-index="9">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Segments Conquered</div>
          <div class="stat-huge"><span class="counter" data-target="0">0</span></div>
          <div class="context">Your favorite stomping grounds.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-icon">üèÜ</div>
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">legend</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">üîÅ</div>
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">efforts</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">podiums</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 11: Morning -->
    <div class="story-card card-morning" data-index="10">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Favorite Start Time</div>
          <div class="stat-huge">--:--<span class="stat-unit">AM</span></div>
          <div class="context">You're an <em>early bird</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">0%</div>
              <div class="mini-card-label">before 8am</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">--:--</div>
              <div class="mini-card-label">earliest</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">--</div>
              <div class="mini-card-label">latest</div>
            </div>
          </div>
          <div class="time-distribution" style="margin-top: 24px;">
            <div class="time-bars" id="timeBars"></div>
            <div class="time-labels"><span class="time-label">5am</span><span class="time-label">9am</span><span
                class="time-label">1pm</span><span class="time-label">5pm</span><span class="time-label">9pm</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 12: Records -->
    <div class="story-card card-records" data-index="11">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Personal Records</div>
          <div class="stat-huge"><span class="counter" data-target="0">0</span></div>
          <div class="context">A year of breakthroughs.</div>
          <div class="mini-cards-row pr-cards-row" id="prCardsRow">
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">1mi</div>
              <div class="mini-card-label">--:--</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">5K</div>
              <div class="mini-card-label">--:--</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">10K</div>
              <div class="mini-card-label">--:--</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">Half</div>
              <div class="mini-card-label">--:--</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-icon">ü•á</div>
              <div class="mini-card-value">Full</div>
              <div class="mini-card-label">--:--</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 13: Best Month -->
    <div class="story-card card-month" data-index="12">
      <div class="noise"></div>
      <div class="grid-overlay"></div>
      <div class="hero-section">
        <div class="stat-content">
          <div class="label">Best Month</div>
          <div class="stat-huge"
            style="font-family: 'Instrument Serif', serif; font-style: italic; transform: none; line-height: 1.2; padding: 0.2em 0.5em; overflow: visible; width: 100vw; max-width: none; margin-left: -24px; margin-right: -24px;">
            Month</div>
          <div class="context">You were <em>on fire</em>.</div>
          <div class="mini-cards-row">
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">mi</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">activities</div>
            </div>
            <div class="mini-card">
              <div class="mini-card-value">0</div>
              <div class="mini-card-label">PRs</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 14: Summary -->
  <div class="story-card card-summary" data-index="13">
    <div class="noise"></div>
    <div class="summary-wrap">
      <div class="summary-header">
        <div class="summary-year">2025</div>
        <div class="summary-tagline">A Year of Relentless Progress</div>
      </div>
      <div class="summary-grid">
        <div class="summary-stat wide">
          <div class="summary-num">2,847 mi</div>
          <div class="summary-lbl">Total Distance</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">312</div>
          <div class="summary-lbl">Activities</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">312 hrs</div>
          <div class="summary-lbl">Time</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">38 ft</div>
          <div class="summary-lbl">Elevation</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">186k</div>
          <div class="summary-lbl">Calories</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">23</div>
          <div class="summary-lbl">PRs</div>
        </div>
        <div class="summary-stat">
          <div class="summary-num">47</div>
          <div class="summary-lbl">Day Streak</div>
        </div>
      </div>
    </div>

  </div>
  </div> <!-- end wrapped-content -->

  <script>
    const TOTAL_CARDS = 14;
    const AUTO_ADVANCE_TIME = 7500;
    let currentIndex = 0;
    let autoAdvanceTimer = null;

    // Gradient spotlight config for each card: [color1, x1, y1, color2, x2, y2, baseColor]
    const gradientConfigs = [
      ['#FF4D00', '50%', '30%', '#8B5CF6', '20%', '80%', '#1a0a10'],      // 0: intro
      ['#00D4FF', '70%', '20%', '#00FFB2', '20%', '75%', '#051518'],      // 1: distance
      ['#FF3366', '30%', '75%', '#FF4D00', '75%', '25%', '#180a10'],      // 2: time
      ['#00FFB2', '25%', '25%', '#00D4FF', '75%', '80%', '#051510'],      // 3: elevation
      ['#FF3366', '65%', '35%', '#8B5CF6', '25%', '70%', '#150810'],      // 4: heartrate
      ['#FF4D00', '50%', '75%', '#FFD700', '50%', '20%', '#181005'],      // 5: calories
      ['#00D4FF', '20%', '25%', '#8B5CF6', '80%', '75%', '#080a15'],      // 6: activities
      ['#FF4D00', '75%', '30%', '#FF3366', '25%', '75%', '#180805'],      // 7: streak
      // Pace card removed
      ['#00FFB2', '65%', '35%', '#FFD700', '30%', '70%', '#081510'],      // 8: kudos
      ['#FFD700', '35%', '70%', '#FF4D00', '70%', '25%', '#151005'],      // 9: routes
      ['#FFD700', '55%', '25%', '#FF4D00', '40%', '80%', '#151008'],      // 10: morning
      ['#FFD700', '70%', '30%', '#FF4D00', '25%', '70%', '#151008'],      // 11: records
      ['#00D4FF', '35%', '70%', '#00FFB2', '65%', '25%', '#051515'],      // 12: month
      ['#FF4D00', '45%', '35%', '#8B5CF6', '70%', '75%', '#150810'],      // 13: summary
    ];

    function updateGradient(index) {
      const config = gradientConfigs[index];
      const spotlight = document.getElementById('gradientSpotlight');
      spotlight.style.setProperty('--spot-color-1', config[0]);
      spotlight.style.setProperty('--spot-x-1', config[1]);
      spotlight.style.setProperty('--spot-y-1', config[2]);
      spotlight.style.setProperty('--spot-color-2', config[3]);
      spotlight.style.setProperty('--spot-x-2', config[4]);
      spotlight.style.setProperty('--spot-y-2', config[5]);
      spotlight.style.setProperty('--base-color', config[6]);
    }

    function init() {
      // Show wrapped content
      document.getElementById('wrappedContent').classList.remove('hidden');

      createProgressBars();
      createKudosHearts();
      updateProgressBars();
      updateGradient(0);
      startAutoAdvance();
    }

    function createProgressBars() {
      const container = document.getElementById('progressContainer');
      for (let i = 0; i < TOTAL_CARDS; i++) {
        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.innerHTML = '<div class="progress-fill"></div>';
        bar.onclick = (e) => { e.stopPropagation(); goToCard(i); };
        container.appendChild(bar);
      }
    }



    function createKudosHearts() {
      const container = document.getElementById('kudosField');
      for (let i = 0; i < 15; i++) {
        const heart = document.createElement('div');
        heart.className = 'kudos-heart';
        heart.textContent = 'üß°';
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDelay = Math.random() * 6 + 's';
        container.appendChild(heart);
      }
    }

    function updateProgressBars() {
      document.querySelectorAll('.progress-bar').forEach((bar, i) => {
        bar.classList.remove('active', 'completed');
        if (i < currentIndex) bar.classList.add('completed');
        else if (i === currentIndex) bar.classList.add('active');
      });
    }

    function animateCounters() {
      const card = document.querySelector('.story-card[data-index="' + currentIndex + '"]');
      if (!card) return;
      card.querySelectorAll('.counter').forEach(counter => {
        const target = parseFloat(counter.dataset.target);
        const start = performance.now();
        const duration = 1500;
        function update(now) {
          const progress = Math.min((now - start) / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          let val = target * eased;
          if (target >= 1000) counter.textContent = Math.floor(val).toLocaleString();
          else if (target < 10) counter.textContent = val.toFixed(1);
          else counter.textContent = Math.floor(val);
          if (progress < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
      });
    }

    function showCard(index) {
      const cards = document.querySelectorAll('.story-card');
      const currentCard = document.querySelector('.story-card.active');
      const nextCard = cards[index];

      // Animate gradient spotlight
      updateGradient(index);

      if (currentCard && currentCard !== nextCard) {
        currentCard.classList.add('exiting');
        currentCard.classList.remove('active');
        setTimeout(() => {
          currentCard.classList.remove('exiting');
        }, 600);
      }

      nextCard.classList.add('active');
      currentIndex = index;
      updateProgressBars();
      setTimeout(animateCounters, 300);
    }

    function goToCard(index) { showCard(index); resetAutoAdvance(); }
    function nextCard() { if (currentIndex < TOTAL_CARDS - 1) { showCard(currentIndex + 1); resetAutoAdvance(); } }
    function prevCard() { if (currentIndex > 0) { showCard(currentIndex - 1); resetAutoAdvance(); } }
    function startAutoAdvance() { if (currentIndex < TOTAL_CARDS - 1) autoAdvanceTimer = setTimeout(nextCard, AUTO_ADVANCE_TIME); }
    function resetAutoAdvance() { clearTimeout(autoAdvanceTimer); startAutoAdvance(); }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextCard(); }
      else if (e.key === 'ArrowLeft') { e.preventDefault(); prevCard(); }
    });

    let touchStartX = 0;
    document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
    document.addEventListener('touchend', (e) => {
      const diff = touchStartX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) diff > 0 ? nextCard() : prevCard();
    }, { passive: true });

    // ============================================
    // STRAVA OAUTH & DATA INTEGRATION
    // ============================================

    // Redirect URI for OAuth
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Store for athlete data
    let athleteData = null;
    let activitiesData = [];

    // ============================================
    // ONBOARDING WIZARD
    // ============================================

    let currentOnboardingStep = 1;
    const TOTAL_ONBOARDING_STEPS = 4;

    function hasCredentials() {
      return localStorage.getItem('strava_credentials_set') === 'true';
    }

    function getStoredClientId() {
      return localStorage.getItem('strava_client_id');
    }

    function getStoredClientSecret() {
      return localStorage.getItem('strava_client_secret');
    }

    function showOnboarding() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('onboardingScreen').classList.remove('hidden');
      currentOnboardingStep = 1;
      updateOnboardingStep(1);
      setupCredentialInputs();
    }

    function hideOnboarding() {
      document.getElementById('onboardingScreen').classList.add('hidden');
    }

    function updateOnboardingStep(step) {
      // Update steps visibility
      for (let i = 1; i <= TOTAL_ONBOARDING_STEPS; i++) {
        const stepEl = document.getElementById(`onboardingStep${i}`);
        const dotEl = document.querySelector(`.progress-dot[data-step="${i}"]`);

        if (i === step) {
          stepEl.classList.remove('exiting');
          stepEl.classList.add('active');
          dotEl.classList.add('active');
          dotEl.classList.remove('completed');
        } else if (i < step) {
          stepEl.classList.remove('active');
          stepEl.classList.add('exiting');
          dotEl.classList.remove('active');
          dotEl.classList.add('completed');
        } else {
          stepEl.classList.remove('active', 'exiting');
          dotEl.classList.remove('active', 'completed');
        }
      }
    }

    function nextOnboardingStep() {
      if (currentOnboardingStep < TOTAL_ONBOARDING_STEPS) {
        currentOnboardingStep++;
        updateOnboardingStep(currentOnboardingStep);
      }
    }

    function prevOnboardingStep() {
      if (currentOnboardingStep > 1) {
        currentOnboardingStep--;
        updateOnboardingStep(currentOnboardingStep);
      }
    }

    function setupCredentialInputs() {
      const clientIdInput = document.getElementById('clientIdInput');
      const clientSecretInput = document.getElementById('clientSecretInput');
      const saveBtn = document.getElementById('saveCredentialsBtn');
      const secretFeedback = document.getElementById('secretFeedback');

      function validateInputs() {
        const clientId = clientIdInput.value.trim();
        const clientSecret = clientSecretInput.value.trim();

        const isClientIdValid = /^\d{4,7}$/.test(clientId);
        const isSecretValid = clientSecret.length >= 30;

        // Show feedback for secret
        if (isSecretValid) {
          secretFeedback.classList.remove('hidden');
        } else {
          secretFeedback.classList.add('hidden');
        }

        saveBtn.disabled = !(isClientIdValid && isSecretValid);
      }

      clientIdInput.addEventListener('input', validateInputs);
      clientSecretInput.addEventListener('input', validateInputs);
      clientSecretInput.addEventListener('paste', () => {
        setTimeout(validateInputs, 10);
      });
    }

    function saveCredentials() {
      const clientId = document.getElementById('clientIdInput').value.trim();
      const clientSecret = document.getElementById('clientSecretInput').value.trim();

      if (!clientId || !clientSecret) {
        return;
      }

      // Save to localStorage
      localStorage.setItem('strava_client_id', clientId);
      localStorage.setItem('strava_client_secret', clientSecret);
      localStorage.setItem('strava_credentials_set', 'true');

      // Show success step
      nextOnboardingStep();

      // After success animation, redirect to Strava OAuth
      setTimeout(() => {
        hideOnboarding();
        connectStrava();
      }, 2000);
    }

    // ============================================
    // SETTINGS MODAL
    // ============================================

    function showSettings() {
      const clientId = getStoredClientId();
      const displayEl = document.getElementById('displayClientId');

      if (clientId) {
        displayEl.textContent = clientId;
      } else {
        displayEl.textContent = 'Not set';
      }

      document.getElementById('settingsModal').classList.remove('hidden');
    }

    function hideSettings() {
      document.getElementById('settingsModal').classList.add('hidden');
    }

    function resetCredentials() {
      if (confirm('This will clear your API credentials. You\'ll need to re-enter them to use the app. Continue?')) {
        localStorage.removeItem('strava_client_id');
        localStorage.removeItem('strava_client_secret');
        localStorage.removeItem('strava_credentials_set');
        hideSettings();
        showOnboarding();
      }
    }

    function clearSession() {
      if (confirm('This will log you out and clear all local data. Continue?')) {
        localStorage.removeItem('strava_access_token');
        localStorage.removeItem('strava_refresh_token');
        localStorage.removeItem('strava_athlete');
        localStorage.removeItem('strava_client_id');
        localStorage.removeItem('strava_client_secret');
        localStorage.removeItem('strava_credentials_set');
        window.location.reload();
      }
    }

    // ============================================
    // OAUTH FUNCTIONS (Using User Credentials)
    // ============================================

    function connectStrava() {
      const clientId = getStoredClientId();

      if (!clientId) {
        showOnboarding();
        return;
      }

      const scope = 'read,activity:read_all,profile:read_all';
      const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${scope}`;
      window.location.href = authUrl;
    }

    async function exchangeToken(code) {
      showLoading('Authenticating...');

      const clientId = getStoredClientId();
      const clientSecret = getStoredClientSecret();

      if (!clientId || !clientSecret) {
        hideLoading();
        showCredentialError('Missing credentials. Please set up your Strava API credentials.');
        return;
      }

      try {
        // Call Strava directly using user's credentials (fully client-side)
        const response = await fetch('https://www.strava.com/oauth/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            client_id: clientId,
            client_secret: clientSecret,
            code: code,
            grant_type: 'authorization_code'
          })
        });

        const data = await response.json();
        debugLog(`Token exchange response: ${response.status}`);

        if (!response.ok) {
          // Check for invalid credentials
          if (response.status === 401 || (data.message && data.message.toLowerCase().includes('invalid'))) {
            hideLoading();
            showCredentialError('Invalid credentials. Please check your Client ID and Client Secret.');
            return;
          }
          if (response.status === 403 || (data.error && JSON.stringify(data.error).toLowerCase().includes('limit'))) {
            hideLoading();
            document.getElementById('errorScreen').classList.remove('hidden');
            return;
          }
          throw new Error(data.message || data.error || 'Failed to get access token');
        }

        if (data.access_token) {
          localStorage.setItem('strava_access_token', data.access_token);
          localStorage.setItem('strava_refresh_token', data.refresh_token);
          localStorage.setItem('strava_athlete', JSON.stringify(data.athlete));
          athleteData = data.athlete;
          await fetchAllActivities(data.access_token);
        } else {
          throw new Error(data.error || 'Failed to get access token');
        }
      } catch (error) {
        console.error('Auth error:', error);
        if (error.message && (error.message.includes('403') || error.message.toLowerCase().includes('limit'))) {
          hideLoading();
          document.getElementById('errorScreen').classList.remove('hidden');
          return;
        }
        // Check if it's a credential issue
        if (error.message && (error.message.toLowerCase().includes('invalid') || error.message.toLowerCase().includes('client'))) {
          hideLoading();
          showCredentialError('There was an issue with your credentials. Please verify them and try again.');
          return;
        }
        hideLoading();
        showCredentialError(`Failed to connect: ${error.message}`);
      }
    }

    function showCredentialError(message) {
      // Update error screen for credential issues
      const errorScreen = document.getElementById('errorScreen');
      const errorTitle = errorScreen.querySelector('.error-title');
      const errorMessage = errorScreen.querySelector('.error-message');
      const errorNote = errorScreen.querySelector('.error-note');
      const tryAgainBtn = errorScreen.querySelector('.strava-btn');

      errorTitle.textContent = 'Credential Issue';
      errorMessage.textContent = message;
      errorNote.innerHTML = 'Make sure your Authorization Callback Domain is set to <strong>recap.fit</strong>';

      // Replace try again button with re-enter credentials button
      tryAgainBtn.textContent = 'Re-enter Credentials';
      tryAgainBtn.onclick = () => {
        errorScreen.classList.add('hidden');
        // Reset error screen to original state
        errorTitle.textContent = 'Hit the Wall';
        errorMessage.textContent = 'We\'re waiting to expand our API access to support as many athletes as we can.';
        errorNote.textContent = 'Please check back later.';
        tryAgainBtn.textContent = 'Try Again';
        tryAgainBtn.onclick = () => window.location.reload();
        // Show onboarding at step 3
        showOnboarding();
        currentOnboardingStep = 3;
        updateOnboardingStep(3);
      };

      errorScreen.classList.remove('hidden');
    }

    async function fetchAllActivities(accessToken) {
      showLoading('Fetching your activities...');
      debugLog('fetchAllActivities started');

      const year = 2025;
      const startOfYear = new Date(year, 0, 1).getTime() / 1000;
      const endOfYear = new Date(year, 11, 31, 23, 59, 59).getTime() / 1000;

      let allActivities = [];
      let page = 1;
      const perPage = 200;

      try {
        while (true) {
          updateLoadingText(`Fetching activities (page ${page})...`);
          debugLog(`Fetching page ${page}...`);

          const response = await fetch(
            `https://www.strava.com/api/v3/athlete/activities?after=${startOfYear}&before=${endOfYear}&page=${page}&per_page=${perPage}`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
          );

          if (!response.ok) {
            if (response.status === 401) {
              debugLog('Session expired (401). Clearing auth and reloading.');
              localStorage.removeItem('strava_access_token');
              localStorage.removeItem('strava_refresh_token');
              localStorage.removeItem('strava_athlete');
              alert('Your session has expired. Please log in again.');
              window.location.reload();
              return;
            }
            if (response.status === 403) {
              debugLog('API Limit reached (403). Showing error screen.');
              hideLoading();
              document.getElementById('errorScreen').classList.remove('hidden');
              return;
            }
            const errorText = await response.text();
            debugLog(`Fetch failed: ${response.status} ${errorText}`);
            alert(`Debug: Fetch failed. Status: ${response.status}, Body: ${errorText}`);
            throw new Error('Failed to fetch activities');
          }

          const activities = await response.json();
          debugLog(`Page ${page} received: ${activities.length} activities`);

          if (activities.length === 0) break;

          allActivities = allActivities.concat(activities);
          page++;

          // Safety limit
          if (page > 20) break;
        }

        activitiesData = allActivities;
        debugLog(`Total activities fetched: ${activitiesData.length}`);
        updateLoadingText('Processing your year...');

        setTimeout(() => {
          processAndDisplayData();
        }, 500);

      } catch (error) {
        console.error('Fetch error:', error);
        debugLog(`Fetch error: ${error.message}`);
        alert('Failed to fetch activities. Please try again.');
        hideLoading();
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    }

    function processAndDisplayData() {
      debugLog('processAndDisplayData started');
      try {
        debugLog('Calculating stats...');
        const stats = calculateStats(activitiesData);
        debugLog('Stats calculated. Updating UI...');
        updateUIWithStats(stats);

        // Re-render charts with real data
        debugLog('Rendering charts...');
        createHeatmap(stats.heatmapData);
        createTimeBars(stats.timeDistribution);
        createMonthBars(stats.monthlyDistance);

        hideLoading();
        hideLogin();

        // Initialize other UI elements
        debugLog('Initializing UI components...');
        document.getElementById('wrappedContent').classList.remove('hidden'); // Reveal the UI!
        createProgressBars();
        createKudosHearts();
        updateProgressBars();
        updateGradient(0);
        startAutoAdvance();
        debugLog('UI Initialization complete');
      } catch (error) {
        console.error('Processing error:', error);
        debugLog(`Processing error: ${error.message}\n${error.stack}`);
        alert(`Error processing data: ${error.name} - ${error.message}\n${error.stack}`);
      }
    }

    function calculateStats(activities) {
      const stats = {
        totalDistance: 0,
        totalTime: 0,
        totalElevation: 0,
        totalCalories: 0,
        totalActivities: activities.length,
        activityTypes: {},
        kudos: 0,
        maxKudos: 0,
        totalComments: 0,
        maxHeartRate: 0,
        avgHeartRate: 0,
        heartRateCount: 0,
        prs: 0,
        fastestKm: Infinity,
        monthlyDistance: new Array(12).fill(0),
        monthlyActivities: new Array(12).fill(0),
        monthlyPRs: new Array(12).fill(0),
        weeklyDistance: new Array(53).fill(0),
        startTimes: new Array(24).fill(0),
        longestStreak: 0,
        uniqueRoutes: new Set(),
        bestMonth: { index: 0, distance: 0 },

        // New stats
        longestActivityDist: 0,
        longestActivityTime: 0,
        maxElevationGain: 0,
        hilliestRun: 0,
        maxCalories: 0,
        maxSpeed: 0,
        totalAchievements: 0,
        activeDays: new Set(),
        heatmapData: Array(53).fill().map(() => Array(7).fill(0)),
        timeDistribution: new Array(16).fill(0), // 5am to 8pm

        fastestPaces: {
          '1mi': { time: Infinity, date: null },
          '5k': { time: Infinity, date: null },
          '10k': { time: Infinity, date: null },
          'half': { time: Infinity, date: null },
          'marathon': { time: Infinity, date: null }
        }
      };

      activities.forEach((activity, index) => {
        // Basic stats
        const dist = activity.distance || 0;
        const time = activity.moving_time || 0;
        const elev = activity.total_elevation_gain || 0;
        // Strava summary activities might not have calories, but rides have kilojoules
        let cals = activity.calories || 0;
        if (!cals && activity.kilojoules) {
          cals = activity.kilojoules; // Rough approximation for cycling
        }

        const date = new Date(activity.start_date);

        if (index < 5) {
          debugLog(`Activity ${activity.id} (${activity.type}): dist=${dist}, cals=${cals} (raw: ${activity.calories}, kj: ${activity.kilojoules})`);
          if (index === 0) debugLog(`Keys: ${Object.keys(activity).join(', ')}`);
        }

        stats.totalDistance += dist;
        stats.totalTime += time;
        stats.totalElevation += elev;
        stats.totalCalories += cals;
        stats.kudos += activity.kudos_count || 0;
        stats.totalComments += activity.comment_count || 0;
        stats.prs += activity.pr_count || 0;
        stats.totalAchievements += activity.achievement_count || 0;

        // Max/Best tracking
        stats.maxKudos = Math.max(stats.maxKudos, activity.kudos_count || 0);
        stats.longestActivityDist = Math.max(stats.longestActivityDist, dist);
        stats.longestActivityTime = Math.max(stats.longestActivityTime, time);
        stats.maxElevationGain = Math.max(stats.maxElevationGain, elev); // Single biggest climb (approx as total gain)
        stats.hilliestRun = Math.max(stats.hilliestRun, elev);
        stats.maxCalories = Math.max(stats.maxCalories, cals);

        // Filter out GPS errors (ignore speeds > 35 m/s or ~126 km/h)
        const speed = activity.max_speed || 0;
        if (speed < 35) {
          stats.maxSpeed = Math.max(stats.maxSpeed, speed);
        } else {
          debugLog(`Ignored unrealistic max speed: ${speed} m/s (${(speed * 3.6).toFixed(1)} km/h) in activity ${activity.id}`);
        }

        // Activity types
        const type = activity.type || 'Other';
        stats.activityTypes[type] = (stats.activityTypes[type] || 0) + 1;

        // Heart rate
        if (activity.max_heartrate) {
          stats.maxHeartRate = Math.max(stats.maxHeartRate, activity.max_heartrate);
        }
        if (activity.average_heartrate) {
          stats.avgHeartRate += activity.average_heartrate;
          stats.heartRateCount++;
        }

        // Fastest pace & PRs (Simplified logic)
        if (type === 'Run' && dist > 0) {
          const pace = time / (dist / 1000); // sec/km
          stats.fastestKm = Math.min(stats.fastestKm, pace);

          // Rough PR tracking based on distance
          const distKm = dist / 1000;
          if (distKm >= 1.6 && time < stats.fastestPaces['1mi'].time) stats.fastestPaces['1mi'] = { time, date };
          if (distKm >= 5 && time < stats.fastestPaces['5k'].time) stats.fastestPaces['5k'] = { time, date };
          if (distKm >= 10 && time < stats.fastestPaces['10k'].time) stats.fastestPaces['10k'] = { time, date };
          if (distKm >= 21.09 && time < stats.fastestPaces['half'].time) stats.fastestPaces['half'] = { time, date };
          if (distKm >= 42.19 && time < stats.fastestPaces['marathon'].time) stats.fastestPaces['marathon'] = { time, date };
        }

        // Monthly stats
        const month = date.getMonth();
        stats.monthlyDistance[month] += dist;
        stats.monthlyActivities[month]++;
        stats.monthlyPRs[month] += activity.pr_count || 0;

        // Weekly stats
        const weekNum = getWeekNumber(date);
        if (weekNum >= 0 && weekNum < 53) {
          stats.weeklyDistance[weekNum] += dist;
        }

        // Time distribution (5am - 8pm)
        // Use string parsing to get the local hour as recorded by the device/user
        // start_date_local is "YYYY-MM-DDTHH:MM:SSZ" or similar.
        let hour = 0;
        if (activity.start_date_local) {
          // Extract HH from THH:MM:SS
          const parts = activity.start_date_local.split('T');
          if (parts.length > 1) {
            hour = parseInt(parts[1].substring(0, 2), 10);
          }
        } else {
          hour = new Date(activity.start_date).getHours();
        }

        stats.startTimes[hour]++;

        // Map 5am (5) to index 0, 8pm (20) to index 15
        if (hour >= 5 && hour <= 20) {
          stats.timeDistribution[hour - 5]++;
        }

        // Heatmap & Streak
        const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
        // Adjust to 0=Mon, 6=Sun for heatmap usually, but let's stick to JS day
        if (weekNum >= 0 && weekNum < 53) {
          // Simple intensity: 1 activity = 1, >10km = 2, >20km = 3, etc.
          let intensity = 1;
          if (dist > 10000) intensity = 2;
          if (dist > 20000) intensity = 3;
          if (dist > 40000) intensity = 4;
          stats.heatmapData[weekNum][dayOfWeek] = Math.max(stats.heatmapData[weekNum][dayOfWeek], intensity);
        }

        stats.activeDays.add(date.toISOString().split('T')[0]);

        // Unique routes
        if (activity.map && activity.map.summary_polyline) {
          stats.uniqueRoutes.add(activity.map.summary_polyline.substring(0, 20));
        }
      });

      // Post-processing
      if (stats.heartRateCount > 0) {
        stats.avgHeartRate = Math.round(stats.avgHeartRate / stats.heartRateCount);
      }

      // Best month
      stats.monthlyDistance.forEach((dist, i) => {
        if (dist > stats.bestMonth.distance) {
          stats.bestMonth = { index: i, distance: dist, activities: stats.monthlyActivities[i] };
        }
      });

      // Best week
      stats.bestWeekDistance = Math.max(...stats.weeklyDistance);
      stats.avgWeeklyDistance = stats.totalDistance / 52;

      // Streak
      stats.longestStreak = calculateLongestStreak(stats.activeDays);
      stats.currentStreak = calculateCurrentStreak(stats.activeDays);

      // Units conversion
      stats.totalDistanceMiles = Math.round(stats.totalDistance * 0.000621371);
      stats.totalTimeHours = Math.round(stats.totalTime / 3600);
      stats.totalElevationFeet = Math.round(stats.totalElevation * 3.28084);
      stats.totalCaloriesK = Math.round(stats.totalCalories / 1000);
      stats.uniqueRoutesCount = stats.uniqueRoutes.size;

      // Calculate total heartbeats (millions)
      const totalMinutes = stats.totalTime / 60;
      const totalBeats = (stats.avgHeartRate || 0) * totalMinutes;
      stats.totalHeartBeatsMillions = (totalBeats / 1000000).toFixed(1);

      // Mini-card formatted values
      stats.formatted = {
        milesPerWeek: (stats.avgWeeklyDistance * 0.000621371).toFixed(1),
        bestWeekMiles: (stats.bestWeekDistance * 0.000621371).toFixed(1),
        longestDistMiles: (stats.longestActivityDist * 0.000621371).toFixed(1),
        avgTimePerActivity: formatDuration(stats.totalTime / stats.totalActivities),
        longestTime: formatDuration(stats.longestActivityTime),
        biggestClimb: Math.round(stats.maxElevationGain * 3.28084) + 'ft',
        hilliestRun: Math.round(stats.hilliestRun * 3.28084) + 'ft',
        dailyAvgCalories: Math.round(stats.totalCalories / 365),
        maxCalories: Math.round(stats.maxCalories).toLocaleString(),
        activePercent: Math.round((stats.activeDays.size / 365) * 100) + '%',
        morningPercent: Math.round((stats.startTimes.slice(5, 9).reduce((a, b) => a + b, 0) / stats.totalActivities) * 100) + '%',
        earliestStart: getEarliestStart(stats.startTimes),
        latestStart: getLatestStart(stats.startTimes)
      };



      // Common start time
      let maxStartTime = 0;
      let commonHour = 6;
      stats.startTimes.forEach((count, hour) => {
        if (count > maxStartTime) {
          maxStartTime = count;
          commonHour = hour;
        }
      });
      const ampm = commonHour >= 12 ? 'PM' : 'AM';
      const displayHour = commonHour % 12 || 12;
      stats.commonStartTime = `${displayHour}:00`;
      stats.commonStartTimeUnit = ampm;

      return stats;
    }

    function formatDuration(seconds) {
      if (!seconds) return '0:00';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}:${m.toString().padStart(2, '0')}` : `${m}m`;
    }

    function formatPace(secondsPerKm) {
      if (secondsPerKm === Infinity || !secondsPerKm) return '--:--';
      const mins = Math.floor(secondsPerKm / 60);
      const secs = Math.round(secondsPerKm % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getEarliestStart(startTimes) {
      // Skip 0-3am (midnight to 3am) unless that's the ONLY time they run.
      // Many manual entries default to midnight.
      let first = -1;
      for (let i = 0; i < 24; i++) {
        if (startTimes[i] > 0) {
          if (first === -1) first = i;
          // If we find something reasonable (>= 4am), return it.
          if (i >= 4) {
            const ampm = i >= 12 ? 'pm' : 'am';
            const h = i % 12 || 12;
            return `${h}${ampm}`;
          }
        }
      }
      // If we only found crazy early times, return the first one
      if (first !== -1) {
        const ampm = first >= 12 ? 'pm' : 'am';
        const h = first % 12 || 12;
        return `${h}${ampm}`;
      }
      return '--';
    }

    function getLatestStart(startTimes) {
      // Find the latest hour with activity
      for (let i = 23; i >= 0; i--) {
        if (startTimes[i] > 0) {
          const ampm = i >= 12 ? 'pm' : 'am';
          const h = i % 12 || 12;
          return `${h}${ampm}`;
        }
      }
      return '--';
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function calculateLongestStreak(datesSet) {
      const dates = Array.from(datesSet).sort();
      if (dates.length === 0) return 0;

      let maxStreak = 1;
      let currentStreak = 1;

      for (let i = 1; i < dates.length; i++) {
        const prev = new Date(dates[i - 1]);
        const curr = new Date(dates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);

        if (diff === 1) {
          currentStreak++;
        } else {
          maxStreak = Math.max(maxStreak, currentStreak);
          currentStreak = 1;
        }
      }
      return Math.max(maxStreak, currentStreak);
    }

    function calculateCurrentStreak(datesSet) {
      if (datesSet.size === 0) return 0;

      const dates = Array.from(datesSet).sort();
      const lastDateStr = dates[dates.length - 1];
      const lastDate = new Date(lastDateStr);

      // Check against today in user's local time (approx)
      const now = new Date();
      // Reset times to compare dates only
      now.setHours(0, 0, 0, 0);
      const last = new Date(lastDate);
      last.setHours(0, 0, 0, 0);

      const diffTime = Math.abs(now - last);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // Allow 0 (today) or 1 (yesterday)
      if (diffDays > 1) return 0;

      let currentStreak = 1;
      for (let i = dates.length - 1; i > 0; i--) {
        const curr = new Date(dates[i]);
        const prev = new Date(dates[i - 1]);

        // Normalize to midnight UTC to avoid DST issues
        curr.setUTCHours(0, 0, 0, 0);
        prev.setUTCHours(0, 0, 0, 0);

        const diff = (curr - prev) / (1000 * 60 * 60 * 24);

        if (Math.round(diff) === 1) {
          currentStreak++;
        } else {
          break;
        }
      }
      return currentStreak;
    }

    function updateUIWithStats(stats) {
      if (athleteData) {
        const nameEl = document.querySelector('.intro-name');
        if (nameEl) {
          const name = athleteData.firstname || 'Your';
          nameEl.textContent = `${name}'s Athletic Journey`;
        }
      }

      // Main Counters
      updateCounter('[data-index="1"] .counter', stats.totalDistanceMiles);
      updateCounter('[data-index="2"] .counter', stats.totalTimeHours);
      updateCounter('[data-index="3"] .counter', stats.totalElevationFeet);
      updateCounter('[data-index="4"] .counter', stats.totalHeartBeatsMillions);
      updateCounter('[data-index="5"] .counter', stats.totalCaloriesK);
      updateCounter('[data-index="6"] .counter', stats.totalActivities);
      updateCounter('[data-index="7"] .counter', stats.longestStreak);
      updateCounter('[data-index="8"] .counter', stats.kudos);
      updateCounter('[data-index="9"] .counter', stats.uniqueRoutesCount);
      updateCounter('[data-index="11"] .counter', stats.prs);

      // Distance Card Mini-stats
      updateMiniCard('.card-distance', 0, stats.formatted.milesPerWeek);
      updateMiniCard('.card-distance', 1, stats.formatted.bestWeekMiles);
      updateMiniCard('.card-distance', 2, stats.formatted.longestDistMiles);

      // Time Card Mini-stats
      updateMiniCard('.card-time', 0, stats.formatted.avgTimePerActivity);
      updateMiniCard('.card-time', 1, stats.formatted.longestTime);

      // Elevation Card Mini-stats
      updateMiniCard('.card-elevation', 0, stats.formatted.biggestClimb);
      updateMiniCard('.card-elevation', 1, stats.formatted.hilliestRun);

      // Heart Rate Card
      updateMiniCard('.card-heartrate', 0, stats.maxHeartRate);
      updateMiniCard('.card-heartrate', 1, stats.avgHeartRate);
      // Resting HR is not available in summary activities. 
      // Replacing with "Zones" placeholder or removing. Let's change label to "Activities with HR"
      updateMiniCard('.card-heartrate', 2, stats.heartRateCount);
      const hrCard = document.querySelector('.card-heartrate');
      if (hrCard) {
        const labels = hrCard.querySelectorAll('.mini-card-label');
        if (labels[2]) labels[2].textContent = 'Recorded';
      }

      // Calories Card
      // Calculate daily average based on active days, not 365, to be more representative of "workout days"
      // Or just total / 365 if we want true daily average. 
      // User said "wrong" (161). 58k total. 
      // Let's change it to "Avg per Activity" which is more accurate/verifiable.
      updateMiniCard('.card-calories', 0, Math.round(stats.totalCalories / stats.totalActivities));
      // Update label
      const calCard = document.querySelector('.card-calories');
      if (calCard) {
        const labels = calCard.querySelectorAll('.mini-card-label');
        if (labels[0]) labels[0].textContent = 'Avg / Activity';
      }
      updateMiniCard('.card-calories', 1, stats.formatted.maxCalories);

      // Activities Card (Breakdown)
      updateActivityBreakdown(stats.activityTypes);

      // Streak Card
      updateMiniCard('.card-streak', 0, stats.currentStreak);
      updateMiniCard('.card-streak', 1, stats.formatted.activePercent);

      // Pace Card - REMOVED

      // Update PR mini-cards (Moved to Records card)
      // ...

      // Kudos Card
      updateMiniCard('.card-kudos', 0, (stats.kudos / stats.totalActivities).toFixed(1));
      updateMiniCard('.card-kudos', 1, stats.maxKudos);
      updateMiniCard('.card-kudos', 2, stats.totalComments);

      // Update label for the 3rd card since we changed it from Given to Comments
      const kudosCard = document.querySelector('.card-kudos');
      if (kudosCard) {
        const labels = kudosCard.querySelectorAll('.mini-card-label');
        if (labels[2]) labels[2].textContent = 'comments';
      }

      // Routes Card
      // Replacing broken placeholders with real data: Max Speed, Achievements
      const maxSpeedMph = (stats.maxSpeed * 2.23694).toFixed(1);
      debugLog(`Segments Card Data: MaxSpeed=${stats.maxSpeed} (${maxSpeedMph} mph), Achievements=${stats.totalAchievements}, Routes=${stats.uniqueRoutesCount}`);

      updateMiniCard('.card-routes', 0, maxSpeedMph);
      updateMiniCard('.card-routes', 1, stats.totalAchievements);
      updateMiniCard('.card-routes', 2, stats.uniqueRoutesCount); // Reusing unique routes count as "Segments" count? Or just hide?

      // Update labels
      const routesCard = document.querySelector('.card-routes');
      if (routesCard) {
        const labels = routesCard.querySelectorAll('.mini-card-label');
        if (labels[0]) labels[0].textContent = 'max mph';
        if (labels[1]) labels[1].textContent = 'achievements';
        if (labels[2]) labels[2].textContent = 'routes';

        const icons = routesCard.querySelectorAll('.mini-card-icon');
        if (icons[0]) icons[0].textContent = '‚ö°';
        if (icons[1]) icons[1].textContent = 'üèÖ';
        if (icons[2]) icons[2].textContent = 'üó∫Ô∏è';
      }

      // Morning Card
      const timeEl = document.querySelector('[data-index="10"] .stat-huge');
      if (timeEl) timeEl.innerHTML = `${stats.commonStartTime}<span class="stat-unit">${stats.commonStartTimeUnit}</span>`;
      updateMiniCard('.card-morning', 0, stats.formatted.morningPercent);
      updateMiniCard('.card-morning', 1, stats.formatted.earliestStart);
      updateMiniCard('.card-morning', 2, stats.formatted.latestStart);

      // Records Card
      // (Using same PR data as Pace card for now)
      // Value = Time, Label = Distance
      updateMiniCard('.card-records', 0, formatDuration(stats.fastestPaces['1mi'].time));
      updateMiniCardLabel('.card-records', 0, '1 Mile');

      updateMiniCard('.card-records', 1, formatDuration(stats.fastestPaces['5k'].time));
      updateMiniCardLabel('.card-records', 1, '5K');

      updateMiniCard('.card-records', 2, formatDuration(stats.fastestPaces['10k'].time));
      updateMiniCardLabel('.card-records', 2, '10K');

      updateMiniCard('.card-records', 3, formatDuration(stats.fastestPaces['half'].time));
      updateMiniCardLabel('.card-records', 3, 'Half');

      updateMiniCard('.card-records', 4, formatDuration(stats.fastestPaces['marathon'].time));
      updateMiniCardLabel('.card-records', 4, 'Full');

      // Best Month Card
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthEl = document.querySelector('[data-index="12"] .stat-huge');
      if (monthEl) monthEl.textContent = months[stats.bestMonth.index];

      updateMiniCard('.card-month', 0, Math.round(stats.bestMonth.distance * 0.000621371));
      updateMiniCard('.card-month', 1, stats.bestMonth.activities);
      updateMiniCard('.card-month', 2, stats.monthlyPRs[stats.bestMonth.index]);

      // Summary Grid
      updateSummary(stats);

      // Update Taglines
      updateTaglines(stats);
    }

    function updateTaglines(stats) {
      const taglines = generateTaglines(stats);

      setTagline('.card-distance .context', taglines.distance);
      setTagline('.card-time .context', taglines.time);
      setTagline('.card-elevation .context', taglines.elevation);
      setTagline('.card-heartrate .context', taglines.heartrate);
      setTagline('.card-calories .context', taglines.calories);
      setTagline('.card-activities .context', taglines.activities);
      setTagline('.card-streak .context', taglines.streak);
      setTagline('.card-kudos .context', taglines.kudos);
      setTagline('.card-routes .context', taglines.routes);
      setTagline('.card-morning .context', taglines.morning);
      setTagline('.card-records .context', taglines.records);
      setTagline('.card-month .context', taglines.month);
    }

    function setTagline(selector, html) {
      const el = document.querySelector(selector);
      if (el && html) el.innerHTML = html;
    }

    function generateTaglines(stats) {
      // Distance
      let distanceTag = '';
      if (stats.totalDistanceMiles > 24901) distanceTag = `You circled the <em>entire Earth</em>!`;
      else if (stats.totalDistanceMiles > 2800) distanceTag = `That's <em>coast to coast</em> across the USA.`;
      else if (stats.totalDistanceMiles > 600) distanceTag = `That's <em>London to Berlin</em> and back.`;
      else distanceTag = `That's <em>${Math.round(stats.totalDistanceMiles / 26.2)} marathons</em> back-to-back.`;

      // Time
      const days = (stats.totalTimeHours / 24).toFixed(1);
      const timeTag = `That's <em>${days} full days</em> of pure motion.`;

      // Elevation
      const everests = (stats.totalElevationFeet / 29029).toFixed(1);
      const elevationTag = `You climbed <em>${everests}x the height of Everest</em>.`;

      // Heart Rate
      const hrTag = `Your heart beat <em>${stats.totalHeartBeatsMillions} million times</em> during workouts.`;

      // Calories
      const pizzas = Math.round(stats.totalCalories / 285); // Slice of pizza
      const calsTag = `That's <em>${pizzas.toLocaleString()} slices of pizza</em> worth of energy.`;

      // Activities
      const avgPerWeek = (stats.totalActivities / 52).toFixed(1);
      const restDays = 365 - stats.activeDays.size;
      const activitiesTag = `That's <em>${avgPerWeek} activities per week</em>. ${restDays} rest days.`;

      // Streak
      let streakTag = `Consistency is key. Keep it up!`;
      if (stats.longestStreak > 3) {
        streakTag = `Your longest streak was <em>${stats.longestStreak} days</em>. Relentless.`;
      }

      // Kudos
      const kudosTag = stats.kudos > 100 ? `You're kind of a <em>big deal</em>.` : `Your community showed up for you.`;

      // Routes
      const routesTag = `You explored <em>${stats.uniqueRoutesCount} unique paths</em> this year.`;

      // Morning
      const hour = stats.commonStartHour || 0;
      let morningTag = `You love a lunch run.`;
      if (hour < 5) morningTag = `You're a <em>night owl</em> (or very early bird).`;
      else if (hour < 10) morningTag = `You're an <em>early bird</em>.`;
      else if (hour >= 17) morningTag = `You own the <em>night</em>.`;

      // Records
      const recordsTag = `A year of <em>${stats.prs} personal records</em>.`;

      // Month
      const monthTag = `You were <em>on fire</em> in ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][stats.bestMonth.index]}.`;

      return {
        distance: distanceTag,
        time: timeTag,
        elevation: elevationTag,
        heartrate: hrTag,
        calories: calsTag,
        activities: activitiesTag,
        streak: streakTag,
        kudos: kudosTag,
        routes: routesTag,
        morning: morningTag,
        records: recordsTag,
        month: monthTag
      };
    }

    function updateMiniCard(cardSelector, index, value) {
      const card = document.querySelector(cardSelector);
      if (!card) return;
      const minis = card.querySelectorAll('.mini-card');
      if (minis[index]) {
        const valEl = minis[index].querySelector('.mini-card-value');
        if (valEl) valEl.textContent = value;
      }
    }

    function updateMiniCardLabel(cardSelector, index, label) {
      const card = document.querySelector(cardSelector);
      if (!card) return;
      const minis = card.querySelectorAll('.mini-card');
      if (minis[index]) {
        const lblEl = minis[index].querySelector('.mini-card-label');
        if (lblEl) lblEl.textContent = label;
      }
    }

    function updateCounter(selector, value) {
      const el = document.querySelector(selector);
      if (el) el.dataset.target = value;
    }

    function updateActivityBreakdown(types) {
      const typeMap = {
        'Run': { emoji: 'üèÉ', name: 'Runs' },
        'Ride': { emoji: 'üö¥', name: 'Rides' },
        'Swim': { emoji: 'üèä', name: 'Swims' },
        'Walk': { emoji: 'üö∂', name: 'Walks' },
        'Hike': { emoji: 'ü•æ', name: 'Hikes' },
        'WeightTraining': { emoji: 'üí™', name: 'Weights' },
        'Workout': { emoji: 'üí™', name: 'Workouts' },
        'Yoga': { emoji: 'üßò', name: 'Yoga' }
      };

      const container = document.querySelector('.card-activities .mini-cards-row');
      if (!container) return;

      const sortedTypes = Object.entries(types)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 4);

      container.innerHTML = sortedTypes.map(([type, count]) => {
        const info = typeMap[type] || { emoji: 'üëü', name: type };
        return `
          <div class="mini-card">
            <div class="mini-card-icon">${info.emoji}</div>
            <div class="mini-card-value">${count}</div>
            <div class="mini-card-label">${info.name}</div>
          </div>
        `;
      }).join('');
    }

    function updateSummary(stats) {
      const summaryValues = document.querySelectorAll('.summary-num');
      if (summaryValues.length >= 7) {
        summaryValues[0].textContent = `${stats.totalDistanceMiles.toLocaleString()} mi`;
        summaryValues[1].textContent = stats.totalActivities;
        summaryValues[2].textContent = `${stats.totalTimeHours} hrs`;
        summaryValues[3].textContent = `${stats.totalElevationFeet.toLocaleString()} ft`;
        summaryValues[4].textContent = `${stats.totalCaloriesK}k`;
        summaryValues[5].textContent = stats.prs;
        summaryValues[6].textContent = stats.longestStreak;
      }
    }

    function createHeatmap(data) {
      const container = document.getElementById('heatmap');
      container.innerHTML = ''; // Clear demo data

      // Data is 53 weeks x 7 days
      for (let week = 0; week < 52; week++) {
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';

          const intensity = data && data[week] ? data[week][day] : 0;
          if (intensity > 0) cell.classList.add(`l${Math.min(intensity, 4)}`);

          container.appendChild(cell);
        }
      }
    }

    function createTimeBars(data) {
      const container = document.getElementById('timeBars');
      if (!container) return;
      container.innerHTML = '';

      // Data is array of 16 hours (5am - 8pm)
      const max = Math.max(...data, 1);

      data.forEach((count, i) => {
        const bar = document.createElement('div');
        bar.className = 'time-bar';
        const height = Math.max((count / max) * 100, 5); // Min 5% height
        bar.style.height = height + '%';
        if (count === max && count > 0) bar.classList.add('peak');
        container.appendChild(bar);
      });
    }

    function createMonthBars(monthlyDistances) {
      const container = document.getElementById('monthBars');
      if (!container) return; // Might not exist in DOM yet if I missed it
      container.innerHTML = '';

      const months = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
      const max = Math.max(...monthlyDistances, 1);

      months.forEach((m, i) => {
        const val = monthlyDistances[i];
        const col = document.createElement('div');
        col.className = 'month-col';

        const bar = document.createElement('div');
        bar.className = 'month-bar' + (val === max && val > 0 ? ' best' : '');
        bar.style.height = Math.max((val / max) * 100, 5) + '%';

        const label = document.createElement('div');
        label.className = 'month-name';
        label.textContent = m;

        col.appendChild(bar);
        col.appendChild(label);
        container.appendChild(col);
      });
    }


    let emojiInterval;
    let textInterval;
    const emojis = ['üèÉ', 'üö¥', 'üèä', 'üö∂', 'ü•æ', 'üí™', 'üßò', '‚õ∑Ô∏è'];
    const loadingPhrases = ['Warming up...', 'Stretching...', 'Processing your year...'];

    function showLoading() {
      document.getElementById('loadingScreen').classList.remove('hidden');
      hideLogin(); // Explicitly hide login screen

      // Start emoji cycling
      if (emojiInterval) clearInterval(emojiInterval);
      let i = 0;
      const el = document.getElementById('emojiCycler');
      emojiInterval = setInterval(() => {
        el.textContent = emojis[i];
        i = (i + 1) % emojis.length;
      }, 500);

      // Start text cycling
      if (textInterval) clearInterval(textInterval);
      let j = 0;
      const textEl = document.getElementById('loadingText');
      textEl.textContent = loadingPhrases[0];
      textInterval = setInterval(() => {
        j = (j + 1) % loadingPhrases.length;
        textEl.textContent = loadingPhrases[j];
      }, 2000);
    }

    function updateLoadingText(text) {
      // No-op as requested by user
    }

    function hideLoading() {
      document.getElementById('loadingScreen').classList.add('hidden');
      if (emojiInterval) clearInterval(emojiInterval);
      if (textInterval) clearInterval(textInterval);
    }

    function hideLogin() {
      document.getElementById('loginScreen').classList.add('hidden');
    }

    // Check for OAuth callback or existing session
    function checkAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      // Check for OAuth error (e.g., wrong callback domain)
      const error = urlParams.get('error');
      if (error) {
        window.history.replaceState({}, document.title, window.location.pathname);
        const errorDesc = urlParams.get('error_description') || 'Authorization was denied';
        showCredentialError(`OAuth Error: ${errorDesc}. Make sure your callback domain is set correctly.`);
        return;
      }

      if (code) {
        // Clear the URL
        window.history.replaceState({}, document.title, window.location.pathname);
        exchangeToken(code);
      } else {
        const token = localStorage.getItem('strava_access_token');
        if (token) {
          debugLog('Found existing token, fetching activities...');
          showLoading('Welcome back! Fetching your year...');
          athleteData = JSON.parse(localStorage.getItem('strava_athlete') || 'null');
          fetchAllActivities(token);
        } else {
          // No token - check if credentials are set
          if (!hasCredentials()) {
            debugLog('No credentials found, showing onboarding.');
            showOnboarding();
          } else {
            debugLog('Credentials found, showing login.');
          }
        }
      }
    }

    // Debug Logger
    function debugLog(msg) {
      console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
    }

    // Run auth check on load
    debugLog('App started. Checking auth...');
    checkAuth();
  </script>
</body>

</html>